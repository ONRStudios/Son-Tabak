<!DOCTYPE html>
<html lang="tr">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <title>Son Tabak Online - v6.8 Mobile UI Fix</title>
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
Â  Â  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
Â  Â Â 
Â  Â  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
Â  Â  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
Â  Â  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
Â  Â  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>

Â  Â  <style>
Â  Â  Â  Â  /* --- STÄ°L DOSYASI --- */
Â  Â  Â  Â  :root {
Â  Â  Â  Â  Â  Â  /* VarsayÄ±lan Turuncu */
Â  Â  Â  Â  Â  Â  --card-pattern: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
Â  Â  Â  Â  Â  Â  --bg-color: #2c3e50;
Â  Â  Â  Â  Â  Â  --primary: #e67e22;
Â  Â  Â  Â  Â  Â  --accent: #f1c40f;
Â  Â  Â  Â  }

Â  Â  Â  Â  body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); color: #333; margin: 0; height: 100vh; display: flex; justify-content: center; align-items: center; overflow: hidden; user-select: none; -webkit-tap-highlight-color: transparent; }
Â  Â  Â  Â  #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* --- GÄ°RÄ°Å EKRANI STÄ°LLERÄ° --- */
Â  Â  Â  Â  #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 8000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; overflow: hidden; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .floating-bg { position: absolute; font-size: 3rem; opacity: 0.3; bottom: -50px; animation: floatAnim linear infinite; pointer-events: none; z-index: 0; }
Â  Â  Â  Â  @keyframes floatAnim {Â 
Â  Â  Â  Â  Â  Â  0% { transform: translateY(0) rotate(0deg); opacity: 0; }Â 
Â  Â  Â  Â  Â  Â  10% { opacity: 0.3; }
Â  Â  Â  Â  Â  Â  90% { opacity: 0.3; }
Â  Â  Â  Â  Â  Â  100% { transform: translateY(-120vh) rotate(360deg); opacity: 0; }Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  .brand-corner { position: absolute; top: 20px; left: 20px; font-size: 1.5em; font-weight: 900; color: var(--primary); z-index: 10; display: flex; align-items: center; gap: 5px; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
Â  Â  Â  Â  .production-corner { position: absolute; bottom: 10px; left: 20px; font-size: 0.7em; color: rgba(255,255,255,0.4); z-index: 10; letter-spacing: 1px; }
Â  Â  Â  Â  .rules-corner { position: absolute; top: 20px; right: 20px; z-index: 9000; }
Â  Â  Â  Â  .icon-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 50%; width: 40px; height: 40px; font-size: 1.5em; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
Â  Â  Â  Â  .icon-btn:hover { background: rgba(255,255,255,0.3); transform: scale(1.1); }

Â  Â  Â  Â  .login-content { position: relative; z-index: 5; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%; }
Â  Â  Â  Â  .logo-container { position: relative; margin-bottom: 20px; }
Â  Â  Â  Â  .plate-anim { font-size: 6em; animation: plateWobble 3s infinite ease-in-out; display: block; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.3)); }
Â  Â  Â  Â  @keyframes plateWobble { 0%, 100% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); } }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .game-title-login { font-size: 3em; font-weight: 900; margin-top: -10px; color: white; text-shadow: 0 4px 0 #000; letter-spacing: -2px; line-height: 1; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .online-stamp { position: absolute; top: 0; right: -30px; background: #c0392b; color: white; padding: 2px 8px; font-size: 0.4em; font-weight: bold; transform: rotate(30deg); border: 2px solid white; box-shadow: 2px 2px 5px rgba(0,0,0,0.3); animation: stampPulse 2s infinite; }
Â  Â  Â  Â  @keyframes stampPulse { 0% { transform: rotate(30deg) scale(1); } 50% { transform: rotate(30deg) scale(1.1); } 100% { transform: rotate(30deg) scale(1); } }

Â  Â  Â  Â  .login-input-group { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); padding: 30px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 50px rgba(0,0,0,0.3); display: flex; flex-direction: column; gap: 15px; width: 300px; max-width: 90%; }
Â  Â  Â  Â  .styled-input { background: rgba(0,0,0,0.3); border: none; padding: 15px; border-radius: 10px; color: white; font-size: 1.1em; text-align: center; outline: none; transition: 0.3s; border: 1px solid transparent; width: 100%; box-sizing: border-box; }
Â  Â  Â  Â  .styled-input:focus { background: rgba(0,0,0,0.5); border-color: var(--primary); }
Â  Â  Â  Â  .styled-input:disabled { opacity: 0.3; cursor: not-allowed; }Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  .login-btn-main { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 10px; font-size: 1.2em; font-weight: bold; cursor: pointer; transition: 0.3s; box-shadow: 0 5px 0 #d35400; width: 100%; }
Â  Â  Â  Â  .login-btn-main:hover { transform: translateY(-2px); box-shadow: 0 7px 0 #d35400; }
Â  Â  Â  Â  .login-btn-main:active { transform: translateY(2px); box-shadow: 0 2px 0 #d35400; }

Â  Â  Â  Â  /* --- LOBÄ° EKRANI STÄ°LLERÄ° --- */
Â  Â  Â  Â  #new-lobby-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 7500; display: none; flex-direction: column; padding: 60px 20px 40px 20px; box-sizing: border-box; overflow: hidden; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .lobby-grid { display: grid; grid-template-columns: 1fr 1.6fr 0.8fr; gap: 15px; height: 100%; width: 100%; max-width: 1400px; margin: 0 auto; grid-template-rows: 1fr auto; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .lobby-col { background: rgba(255,255,255,0.95); border-radius: 15px; padding: 15px; display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; position: relative; transition: all 0.3s ease; }
Â  Â  Â  Â  .col-title { font-size: 1.2em; font-weight: 800; color: #2c3e50; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 2px solid #eee; display: flex; justify-content: space-between; align-items: center; user-select: none; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .col-title::after { content: ''; display: none; }

Â  Â  Â  Â  .create-form { display: flex; flex-direction: column; gap: 10px; }
Â  Â  Â  Â  .player-count-select { display: flex; gap: 10px; margin: 5px 0; }
Â  Â  Â  Â  .p-count-btn { flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 8px; background: #fff; cursor: pointer; font-weight: bold; color: #777; transition: 0.2s; font-size: 0.9em; }
Â  Â  Â  Â  .p-count-btn.active { border-color: #2ecc71; background: #e8f8f5; color: #2ecc71; }
Â  Â  Â  Â  .p-count-btn.disabled { opacity: 0.5; cursor: not-allowed; background: #eee; }Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  .mode-check { display: flex; align-items: center; gap: 10px; background: #f9f9f9; padding: 10px; border-radius: 8px; margin-top: 5px; cursor: pointer; border: 1px solid #eee; }
Â  Â  Â  Â  .mode-check:hover { background: #f0f0f0; }
Â  Â  Â  Â  .mode-check input { width: 18px; height: 18px; cursor: pointer; }

Â  Â  Â  Â  .room-scroll { overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 8px; }
Â  Â  Â  Â  .lobby-room-item { background: white; border: 1px solid #eee; padding: 10px; border-radius: 10px; display: flex; align-items: center; justify-content: space-between; transition: 0.2s; }
Â  Â  Â  Â  .lobby-room-item:hover { transform: translateX(3px); border-color: #bdc3c7; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
Â  Â  Â  Â  .room-status-dot { width: 12px; height: 12px; border-radius: 50%; margin-right: 10px; flex-shrink: 0; }
Â  Â  Â  Â  .st-green { background: #2ecc71; box-shadow: 0 0 5px #2ecc71; }
Â  Â  Â  Â  .st-yellow { background: #f1c40f; box-shadow: 0 0 5px #f1c40f; }
Â  Â  Â  Â  .st-red { background: #e74c3c; box-shadow: 0 0 5px #e74c3c; }
Â  Â  Â  Â  .room-info { display: flex; align-items: center; flex: 1; }
Â  Â  Â  Â  .room-name-txt { font-weight: bold; color: #333; margin-right: 10px; }
Â  Â  Â  Â  .room-count-pill { font-size: 0.8em; background: #eee; padding: 2px 6px; border-radius: 4px; color: #555; }
Â  Â  Â  Â  .room-action-btn { padding: 6px 15px; font-size: 0.9em; border-radius: 6px; cursor: pointer; border: none; background: #3498db; color: white; font-weight: bold; display: flex; align-items: center; gap: 5px; }
Â  Â  Â  Â  .room-action-btn:hover { background: #2980b9; }

Â  Â  Â  Â  .lobby-col.players-col { grid-column: 3; grid-row: 1 / span 2; }
Â  Â  Â  Â  .player-list-scroll { overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 2px; }
Â  Â  Â  Â  .lobby-player-row { display: flex; align-items: center; padding: 4px 8px; border-bottom: 1px dashed #eee; font-size: 0.85em; }
Â  Â  Â  Â  .p-status-dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; }
Â  Â  Â  Â  .pst-lobby { background: #2ecc71; } /* Lobby */
Â  Â  Â  Â  .pst-wait { background: #f1c40f; } /* Waiting Room */
Â  Â  Â  Â  .pst-game { background: #e74c3c; } /* In Game */
Â  Â  Â  Â  .pst-disc { background: #7f8c8d; } /* Disconnected */

Â  Â  Â  Â  .lobby-chat-wrapper { grid-column: 1 / 3; background: rgba(255,255,255,0.95); border-radius: 15px; padding: 10px; display: flex; flex-direction: column; height: 200px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
Â  Â  Â  Â  .l-chat-msgs { flex: 1; overflow-y: auto; background: #fcfcfc; border: 1px solid #eee; border-radius: 8px; padding: 10px; font-size: 0.85em; margin-bottom: 5px; display: flex; flex-direction: column; gap: 4px; }
Â  Â  Â  Â  .l-chat-input { display: flex; gap: 5px; }
Â  Â  Â  Â  .l-chat-in { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px; outline: none; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  #main-game-wrapper { display: none; } /* Default hidden */
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* --- MOBILE LOBBY & GAME OPTIMIZATION --- */
Â  Â  Â  Â  @media screen and (max-width: 900px) {
Â  Â  Â  Â  Â  Â  #login-screen { padding: 20px; box-sizing: border-box; }
Â  Â  Â  Â  Â  Â  .login-input-group { width: 90% !important; padding: 25px; }
Â  Â  Â  Â  Â  Â  .game-title-login { font-size: 2.2em; }
Â  Â  Â  Â  Â  Â  .plate-anim { font-size: 4em; }
Â  Â  Â  Â  Â  Â  .brand-corner { font-size: 1.2em; top: 10px; left: 10px; }
Â  Â  Â  Â  Â  Â  .production-corner { font-size: 0.6em; bottom: 5px; left: 10px; }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  /* Lobby Screen Mobile */
Â  Â  Â  Â  Â  Â  #new-lobby-screen {Â 
Â  Â  Â  Â  Â  Â  Â  Â  overflow-y: auto;Â 
Â  Â  Â  Â  Â  Â  Â  Â  padding: 50px 10px 10px 10px;Â 
Â  Â  Â  Â  Â  Â  Â  Â  display: none;Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  .lobby-grid {Â 
Â  Â  Â  Â  Â  Â  Â  Â  display: flex;Â 
Â  Â  Â  Â  Â  Â  Â  Â  flex-direction: column;Â 
Â  Â  Â  Â  Â  Â  Â  Â  height: auto;Â 
Â  Â  Â  Â  Â  Â  Â  Â  gap: 10px;
Â  Â  Â  Â  Â  Â  Â  Â  padding-bottom: 20px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .lobby-col {Â 
Â  Â  Â  Â  Â  Â  Â  Â  width: 100%;Â 
Â  Â  Â  Â  Â  Â  Â  Â  box-sizing: border-box;Â 
Â  Â  Â  Â  Â  Â  Â  Â  min-height: auto;
Â  Â  Â  Â  Â  Â  Â  Â  max-height: 50px; /* VarsayÄ±lan kapalÄ± yÃ¼kseklik */
Â  Â  Â  Â  Â  Â  Â  Â  flex: none;
Â  Â  Â  Â  Â  Â  Â  Â  padding: 10px 15px;
Â  Â  Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .lobby-col.open-tab {
Â  Â  Â  Â  Â  Â  Â  Â  max-height: 500px; /* AÃ§Ä±k yÃ¼kseklik */
Â  Â  Â  Â  Â  Â  Â  Â  cursor: default;
Â  Â  Â  Â  Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .col-title {
Â  Â  Â  Â  Â  Â  Â  Â  margin-bottom: 0;
Â  Â  Â  Â  Â  Â  Â  Â  border-bottom: none;
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 1em;
Â  Â  Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .lobby-col.open-tab .col-title {
Â  Â  Â  Â  Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  Â  Â  Â  Â  border-bottom: 2px solid #eee;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  .col-title::after {
Â  Â  Â  Â  Â  Â  Â  Â  content: 'â–¼';
Â  Â  Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 0.8em;
Â  Â  Â  Â  Â  Â  Â  Â  color: #7f8c8d;
Â  Â  Â  Â  Â  Â  Â  Â  transition: transform 0.3s;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .lobby-col.open-tab .col-title::after {
Â  Â  Â  Â  Â  Â  Â  Â  transform: rotate(180deg);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  .col-content {
Â  Â  Â  Â  Â  Â  Â  Â  opacity: 0;
Â  Â  Â  Â  Â  Â  Â  Â  transition: opacity 0.3s;
Â  Â  Â  Â  Â  Â  Â  Â  pointer-events: none;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  .lobby-col.open-tab .col-content {
Â  Â  Â  Â  Â  Â  Â  Â  opacity: 1;
Â  Â  Â  Â  Â  Â  Â  Â  pointer-events: auto;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .styled-input, .p-count-btn, .mode-check { font-size: 0.85em !important; padding: 8px !important; }
Â  Â  Â  Â  Â  Â  .lobby-room-item { padding: 8px; font-size: 0.85em; }
Â  Â  Â  Â  Â  Â  .room-action-btn { padding: 5px 10px; font-size: 0.8em; }

Â  Â  Â  Â  Â  Â  .room-scroll, .player-list-scroll {
Â  Â  Â  Â  Â  Â  Â  Â  max-height: 200px;Â 
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .lobby-chat-wrapper {Â 
Â  Â  Â  Â  Â  Â  Â  Â  width: 100%;Â 
Â  Â  Â  Â  Â  Â  Â  Â  box-sizing: border-box;Â 
Â  Â  Â  Â  Â  Â  Â  Â  height: 150px;Â 
Â  Â  Â  Â  Â  Â  Â  Â  flex-shrink: 0;
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 0.85em;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  .lobby-chat-wrapper input { font-size: 0.9em; }
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- OYUN ALANI DÃœZENÄ° (PC) --- */
Â  Â  Â  Â  .room-item { border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.2s; }
Â  Â  Â  Â  .room-item:hover { background: #f0f0f0; }
Â  Â  Â  Â  .player-list { list-style: none; padding: 0; margin: 10px 0; }
Â  Â  Â  Â  .player-item { padding: 5px; border-bottom: 1px dashed #eee; display: flex; justify-content: space-between; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* PC LAYOUT: Grid */
Â  Â  Â  Â  .main-wrapper {Â 
Â  Â  Â  Â  Â  Â  display: grid;Â 
Â  Â  Â  Â  Â  Â  width: 98%;Â 
Â  Â  Â  Â  Â  Â  max-width: 1400px;Â 
Â  Â  Â  Â  Â  Â  height: 98vh;Â 
Â  Â  Â  Â  Â  Â  gap: 10px;Â 
Â  Â  Â  Â  Â  Â  padding: 5px;Â 
Â  Â  Â  Â  Â  Â  box-sizing: border-box;Â 
Â  Â  Â  Â  Â  Â  grid-template-columns: 1fr 300px;Â 
Â  Â  Â  Â  Â  Â  grid-template-rows: auto 1fr auto;Â 
Â  Â  Â  Â  Â  Â  grid-template-areas:Â 
Â  Â  Â  Â  Â  Â  Â  Â  "game logo"Â 
Â  Â  Â  Â  Â  Â  Â  Â  "game panel"Â 
Â  Â  Â  Â  Â  Â  Â  Â  "game buttons";Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  #brand-area { grid-area: logo; text-align: center; background: #fff; padding: 10px; border-radius: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; flex-direction: column; justify-content: center; height: fit-content; }
Â  Â  Â  Â  .brand-title { font-size: 1.5em; font-weight: 900; color: #2c3e50; line-height: 1; }
Â  Â  Â  Â  .version { font-size: 0.4em; color: #95a5a6; margin-left: 5px; font-weight: normal; }
Â  Â  Â  Â  .brand-sub { font-size: 1.2em; font-weight: bold; color: #e67e22; margin-top: 5px; letter-spacing: -1px; }

Â  Â  Â  Â  .right-panel { grid-area: panel; display: flex; flex-direction: column; gap: 10px; height: 100%; overflow: hidden; }
Â  Â  Â  Â  .flip-container { background-color: transparent; width: 100%; height: 200px; perspective: 1000px; cursor: pointer; flex-shrink: 0; }
Â  Â  Â  Â  .flip-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; border-radius: 15px; box-shadow: 0 3px 10px rgba(0,0,0,0.2); }
Â  Â  Â  Â  .flip-container.flipped .flip-inner { transform: rotateY(180deg); }
Â  Â  Â  Â  .flip-front, .flip-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; background: #fff; border-radius: 15px; overflow: hidden; display: flex; flex-direction: column; }
Â  Â  Â  Â  .flip-back { transform: rotateY(180deg); background: #fdfdfd; }
Â  Â  Â  Â  .panel-header { font-weight: bold; color: #fff; background: #34495e; padding: 5px; font-size: 0.9em; display: flex; justify-content: space-between; align-items: center; padding-left: 10px; padding-right: 10px;}
Â  Â  Â  Â Â 
Â  Â  Â  Â  #score-table { width: 100%; font-size: 0.85em; border-collapse: collapse; margin-top: 5px; table-layout: fixed; }
Â  Â  Â  Â  #score-table tr { display: table-row; }
Â  Â  Â  Â  #score-table td { padding: 4px 6px; border-bottom: 1px solid #eee; text-align: left; vertical-align: middle; font-size: 0.9em; }
Â  Â  Â  Â  .me-row { background-color: #fff9c4; font-weight: bold; border-left: 4px solid #f1c40f; }

Â  Â  Â  Â  #system-log { overflow-y: auto; flex-grow: 1; font-size: 0.75em; text-align: left; padding: 5px; list-style: none; margin: 0; }
Â  Â  Â  Â  #system-log li { padding: 2px 0; border-bottom: 1px dashed #eee; color: #555; }
Â  Â  Â  Â  .chat-container { background: #fff; border-radius: 15px; box-shadow: 0 3px 10px rgba(0,0,0,0.2); flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
Â  Â  Â  Â  #chat-messages { flex-grow: 1; overflow-y: auto; padding: 10px; font-size: 0.85em; display: flex; flex-direction: column; gap: 4px; background: #fcfcfc; text-align: left;}
Â  Â  Â  Â  .chat-line { line-height: 1.4; border-bottom: 1px solid #eee; padding-bottom: 2px;}
Â  Â  Â  Â  .chat-input-area { display: flex; padding: 5px; border-top: 1px solid #eee; box-sizing: border-box; width: 100%; }
Â  Â  Â  Â  #player-input { flex-grow: 1; border: 1px solid #ccc; border-radius: 20px; padding: 5px 10px; font-size: 0.8em; outline: none; min-width: 0; }
Â  Â  Â  Â  #send-btn { background: #3498db; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; margin-left: 5px; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 1.2em; flex-shrink: 0; }

Â  Â  Â  Â  .game-container { grid-area: game; background: #ecf0f1; border-radius: 20px; box-shadow: 0 15px 40px rgba(0,0,0,0.7); display: grid; grid-template-rows: auto 1fr auto; align-items: center; justify-items: center; position: relative; overflow: hidden; padding: 10px 0; background-color: #fdfbf7; background-image: repeating-linear-gradient(90deg, transparent, transparent 50px, rgba(231, 76, 60, 0.10) 50px, rgba(231, 76, 60, 0.10) 100px), repeating-linear-gradient(0deg, transparent, transparent 50px, rgba(231, 76, 60, 0.10) 50px, rgba(231, 76, 60, 0.10) 100px); transition: box-shadow 0.5s; border: 4px solid transparent; height: 100%; }
Â  Â  Â  Â  .ambient-red { box-shadow: inset 0 0 60px rgba(231, 76, 60, 0.4) !important; border-color: #c0392b !important; }
Â  Â  Â  Â  .ambient-green { box-shadow: inset 0 0 60px rgba(46, 204, 113, 0.4) !important; border-color: #27ae60 !important; }
Â  Â  Â  Â  .ambient-yellow { box-shadow: inset 0 0 60px rgba(241, 196, 15, 0.4) !important; border-color: #f39c12 !important; }
Â  Â  Â  Â  .ambient-purple { box-shadow: inset 0 0 60px rgba(142, 68, 173, 0.4) !important; border-color: #8e44ad !important; }
Â  Â  Â  Â  #top-area { display: grid; grid-template-columns: 1fr auto 1fr auto 1fr; align-items: center; justify-items: center; width: 95%; padding-top: 10px; min-height: 140px; position: relative; z-index: 5; grid-row: 1; align-self: start; }
Â  Â  Â  Â  .bot-wrapper { display: flex; flex-direction: column; align-items: center; justify-content: flex-start; width: 100px; position: relative; transition: 0.3s; }
Â  Â  Â  Â  .bot-name { background: white; padding: 4px 10px; border-radius: 12px; font-weight: bold; font-size: 0.8em; z-index: 5; margin-bottom: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: 0.3s; white-space: nowrap; border: 1px solid #ddd; }
Â  Â  Â  Â  .current-player .bot-name { background: #3498db; color: white; box-shadow: 0 0 10px #3498db; transform: scale(1.1); border-color: #2980b9; }
Â  Â  Â  Â  .chat-bubble { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; border: 2px solid #333; padding: 5px 8px; border-radius: 8px; font-size: 0.7em; font-weight: bold; white-space: normal; width: 120px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.4); z-index: 300; opacity: 0; pointer-events: none; line-height: 1.1; display: flex; align-items: center; justify-content: center; transition: opacity 0.3s; }
Â  Â  Â  Â  .chat-bubble.visible { opacity: 1; }
Â  Â  Â  Â  .bot-stack-visual { position: relative; height: 90px; width: 100px; margin-top: 5px; transition: width 0.3s; display: flex; justify-content: center; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .mini-card-back { width: 60px; height: 90px; border: 3px solid #fff; border-radius: 8px; position: absolute; box-shadow: 2px 2px 5px rgba(0,0,0,0.3); background-size: cover; background-position: center; box-sizing: border-box; display: flex; justify-content: center; align-items: center; overflow: hidden; transition: all 0.3s; background: var(--card-pattern) !important; }
Â  Â  Â  Â  .card-back-style { background: var(--card-pattern) !important; background-size: cover; border: 3px solid #fff !important; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .mini-card-back::after, .card-back-style::after { content: "SON\A TABAK"; position: absolute; transform: rotate(-15deg); color: #3498db; font-family: 'Comic Sans MS', cursive; font-weight: 900; font-size: 1.1em; white-space: pre; text-align: center; line-height: 0.9; pointer-events: none; text-shadow: 2px 2px 0 #fff; }
Â  Â  Â  Â  .mini-card-back::after { font-size: 0.75em; transform: rotate(-15deg) scale(0.8); }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* OKLAR */
Â  Â  Â  Â  .arrow-icon { font-size: 2.5em; color: #bdc3c7; font-weight: 900; transition: all 0.5s; z-index: 10; position: absolute; top: 50%; transform: translateY(-50%); opacity: 1; }
Â  Â  Â  Â  .arrow-icon.active { animation: pulseArrow 2s infinite; text-shadow: 0 0 20px currentColor; z-index: 20; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .arrow-top-static { position: static; margin: 0 15px; font-size: 2.5em; color: #bdc3c7; font-weight: 900; transition: all 0.3s; display: inline-block; transform-origin: center; transform: scale(1); }
Â  Â  Â  Â  .arrow-top-static.active { animation: pulseArrowStatic 1.2s infinite ease-in-out; text-shadow: 0 0 20px currentColor; color: #3498db; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  @keyframes pulseArrow { 0% { transform: translateY(-50%) scale(1.0); } 50% { transform: translateY(-50%) scale(1.25); } 100% { transform: translateY(-50%) scale(1.0); } }
Â  Â  Â  Â  @keyframes pulseArrowStatic { 0% { transform: scale(1.0); } 50% { transform: scale(1.3); } 100% { transform: scale(1.0); } }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .arrow-spin { animation: spinArrow 1.2s ease-in-out forwards !important; }
Â  Â  Â  Â  @keyframes spinArrow { 0% { transform: translateY(-50%) rotate(0deg) scale(1); } 50% { transform: translateY(-50%) rotate(180deg) scale(1.4); color: #e74c3c; } 100% { transform: translateY(-50%) rotate(360deg) scale(1); } }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .glow-red { color: #c0392b !important; } .glow-green { color: #27ae60 !important; } .glow-yellow { color: #f1c40f !important; } .glow-purple { color: #9b59b6 !important; } .glow-neutral { color: #3498db !important; }
Â  Â  Â  Â  #arrow-left { left: 25px; } #arrow-right { right: 25px; }Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  #play-area { display: flex; align-items: center; justify-content: center; gap: 80px; width: 100%; min-height: 180px; position: relative; transition: transform 0.3s; z-index: 5; grid-row: 2; align-self: center; }
Â  Â  Â  Â  .card { width: 105px; height: 155px; border-radius: 12px; display: flex; flex-direction: column; justify-content: center; align-items: center; font-weight: bold; cursor: pointer; border: 3px solid #555; box-shadow: 5px 5px 15px rgba(0,0,0,0.2); background-color: white; position: relative; user-select: none; transition: transform 0.2s; box-sizing: border-box; flex-shrink: 0; }
Â  Â  Â  Â  #draw-pile.card:hover { transform: none; }
Â  Â  Â  Â  .playable:hover { transform: translateY(-30px) scale(1.1); z-index: 100; }
Â  Â  Â  Â  .playable { border-color: #333; }Â 
Â  Â  Â  Â  .card-corner { position: absolute; font-size: 1.2em; margin: 5px; }
Â  Â  Â  Â  .top-left { top: 2px; left: 2px; } .bottom-right { bottom: 2px; right: 2px; transform: rotate(180deg); }
Â  Â  Â  Â  .card-emoji { font-size: 4.5em; display: flex; justify-content: center; align-items: center; width: 100%; height: 100%; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .card[data-val="+2"] .card-emoji {Â 
Â  Â  Â  Â  Â  Â  font-size: 3em !important;Â 
Â  Â  Â  Â  Â  Â  letter-spacing: -6px !important;Â 
Â  Â  Â  Â  Â  Â  line-height: 1;Â 
Â  Â  Â  Â  Â  Â  padding: 0;Â 
Â  Â  Â  Â  Â  Â  white-space: nowrap !important;Â 
Â  Â  Â  Â  Â  Â  display: flex !important;
Â  Â  Â  Â  Â  Â  flex-direction: row !important;
Â  Â  Â  Â  Â  Â  gap: 0px !important;
Â  Â  Â  Â  Â  Â  margin-left: -3px;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .guvec-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2px; font-size: 0.45em; line-height: 1; }
Â  Â  Â  Â  .red { background-color: #ffcdd2; color: #c0392b; border-color: #c0392b; } .green { background-color: #c8e6c9; color: #27ae60; border-color: #27ae60; } .yellow { background-color: #fff9c4; color: #f39c12; border-color: #f39c12; } .purple { background-color: #e1bee7; color: #8e44ad; border-color: #8e44ad; }
Â  Â  Â  Â  .wild-bg { background: conic-gradient(from 45deg, #e74c3c, #f1c40f, #2ecc71, #9b59b6, #e74c3c); border: 3px solid #fff; color: #fff; }
Â  Â  Â  Â  #penalty-badge { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: 900; font-size: 1.2em; color: white; width: 40px; height: 40px; border-radius: 50%; border: 3px solid white; display: none; justify-content: center; align-items: center; z-index: 70; transition: all 0.3s; animation: pulseBadge 1s infinite; text-shadow: 1px 1px 0 rgba(0,0,0,0.5); }
Â  Â  Â  Â  /* FIX: Renkler DÃ¼zeltildi */
Â  Â  Â  Â  #penalty-badge.p-1 { background: #2ecc71; box-shadow: 0 0 10px #2ecc71; } /* YeÅŸil */
Â  Â  Â  Â  #penalty-badge.p-2 { background: #f1c40f; box-shadow: 0 0 10px #f1c40f; } /* SarÄ± */
Â  Â  Â  Â  #penalty-badge.p-3 { background: #e67e22; box-shadow: 0 0 15px #e67e22; } /* Turuncu */
Â  Â  Â  Â  #penalty-badge.p-4 { background: #e74c3c; box-shadow: 0 0 20px #e74c3c; transform: scale(1.1); } /* KÄ±rmÄ±zÄ± */
Â  Â  Â  Â  #penalty-badge.p-5 { background: #9b59b6; box-shadow: 0 0 20px #9b59b6; transform: scale(1.15); } /* Mor */
Â  Â  Â  Â  #penalty-badge.p-6 { background: #2c3e50; box-shadow: 0 0 25px #000; transform: scale(1.2); } /* Siyah */

Â  Â  Â  Â  @keyframes pulseBadge { 0% { transform: translate(-50%, -50%) scale(1); } 50% { transform: translate(-50%, -50%) scale(1.15); } 100% { transform: translate(-50%, -50%) scale(1); } }
Â  Â  Â  Â  #draw-counter { display: none; }
Â  Â  Â  Â  #bottom-area { width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; margin-bottom: 10px; position: relative; z-index: 10; grid-row: 3; align-self: end; }
Â  Â  Â  Â  #son-tabak-container { margin-bottom: 5px; z-index: 10; display:flex; gap:10px; }
Â  Â  Â  Â  #son-tabak-btn, #challenge-btn { padding: 12px 30px; border: none; border-radius: 30px; font-size: 1.2em; font-weight: bold; cursor: pointer; color: white; box-shadow: 0 5px 0 rgba(0,0,0,0.2); transition: 0.2s; }
Â  Â  Â  Â  #son-tabak-btn { background-color: #e67e22; } #challenge-btn { background-color: #f1c40f; color: #333; }
Â  Â  Â  Â  #son-tabak-btn:disabled, #challenge-btn:disabled { background-color: #bdc3c7; box-shadow: none; cursor: not-allowed; opacity: 0.6; color:#fff; }
Â  Â  Â  Â  #player-hand { display: flex; flex-wrap: wrap; justify-content: center; align-content: center; align-items: center; gap: 8px; width: 90%; padding: 10px; height: auto; min-height: 160px; border: 2px dashed rgba(0,0,0,0.1); border-radius: 25px; overflow: visible; transition: all 0.3s; }
Â  Â  Â  Â  .current-player-area { border: 4px dashed #3498db !important; background: rgba(255, 255, 255, 0.4) !important; box-shadow: 0 0 20px rgba(52, 152, 219, 0.5); }
Â  Â  Â  Â  .hand-normal .card { width: 105px; height: 155px; }
Â  Â  Â  Â  .hand-packed .card { width: 80px; height: 120px; font-size: 0.8em; border-width: 2px; } .hand-packed .card-emoji { font-size: 2.5em; }
Â  Â  Â  Â  .hand-super-packed .card { width: 60px; height: 90px; font-size: 0.6em; border-width: 2px; } .hand-super-packed .card-emoji { font-size: 1.8em; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* PC Button Container - Right Bottom */
Â  Â  Â  Â  .buttons-container { grid-area: game buttons; display: flex; flex-direction: column; gap: 8px; margin-top: auto; padding: 5px; }
Â  Â  Â  Â  .game-btn { padding: 12px 20px; border: none; border-radius: 10px; font-size: 1em; font-weight: bold; cursor: pointer; color: white; width: 100%; margin-bottom: 0; transition: 0.2s; }
Â  Â  Â  Â  .game-btn:hover { transform: translateY(-2px); box-shadow: 0 3px 10px rgba(0,0,0,0.2); }
Â  Â  Â  Â  .btn-red { background-color: #c0392b; } .btn-blue { background-color: #3498db; } .btn-dark { background-color: #34495e; } .btn-green { background-color: #27ae60; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .flying-card { position: fixed; z-index: 3000; pointer-events: none; transition: all 1.0s ease-in-out; }
Â  Â  Â  Â  .blocked-anim { position: absolute; font-size: 4em; color: #c0392b; z-index: 300; text-shadow: 0 0 20px #fff; animation: fadeUp 2s forwards; pointer-events: none; transform: translate(-50%, -50%); }
Â  Â  Â  Â  @keyframes fadeUp { 0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); } 20% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); } 80% { opacity: 1; } 100% { opacity: 0; transform: translate(-50%, -100px); } }
Â  Â  Â  Â  .mixer-container { position: absolute; top: 50%; left: 50%; width: 0; height: 0; z-index: 4000; pointer-events: none; }
Â  Â  Â  Â  .mixer-card { position: absolute; width: 70px; height: 100px; border: 3px solid #fff; border-radius: 8px; background-size: cover; background-position: center; box-shadow: 0 0 10px rgba(0,0,0,0.5); transform-origin: center 250px; top: -300px; left: -35px; background: var(--card-pattern) !important; }
Â  Â  Â  Â  .mixer-card::after { content: "SON\A TABAK"; position: absolute; transform: rotate(-15deg); color: #3498db; font-weight: 900; font-size: 0.75em; white-space: pre; text-align: center; line-height:0.9; top: 35%; left: 5px; font-family: 'Comic Sans MS', cursive; }
Â  Â  Â  Â  .anim-temp-card { position: fixed; width: 70px; height: 100px; border: 3px solid #fff; border-radius: 8px; background-size: cover; background-position: center; z-index: 4000; box-shadow: 0 0 10px rgba(0,0,0,0.5); pointer-events: none; }
Â  Â  Â  Â  .anim-temp-card::after { content: "SON\A TABAK"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg); color: #3498db; font-weight: 900; font-size: 0.9em; white-space: pre; text-align: center; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* FIX: Modal z-index increased to 9999 to show above Login/Lobby */
Â  Â  Â  Â  .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 9999; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .modal-box { background: white; padding: 30px; border-radius: 20px; text-align: center; width: 80%; max-width: 320px; height: auto; display: flex; flex-direction: column; align-items: center; justify-content: center; }
Â  Â  Â  Â  .input-field { padding: 10px; width: 80%; margin: 5px; border: 1px solid #ccc; border-radius: 5px; }
Â  Â  Â  Â  .color-picker { display: flex; justify-content: center; gap: 15px; margin-top: 15px; flex-wrap: wrap; }
Â  Â  Â  Â  .color-opt { width: 50px; height: 50px; border-radius: 50%; border: 4px solid #333; cursor: pointer; transition: 0.2s; flex-shrink: 0; }
Â  Â  Â  Â  .bg-red { background: #e74c3c; } .bg-green { background: #2ecc71; } .bg-yellow { background: #f1c40f; } .bg-purple { background: #9b59b6; }
Â  Â  Â  Â  .pattern-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; }
Â  Â  Â  Â  .pattern-opt { width: 50px; height: 70px; border: 2px solid #ccc; cursor: pointer; background-size: cover; position: relative; }
Â  Â  Â  Â  .pattern-opt::after { content: "SON"; position: absolute; transform: rotate(-15deg) scale(0.5); color: #3498db; font-weight: 900; top: 35%; left: 5px; text-shadow: 1px 1px 0 white; }
Â  Â  Â  Â  #son-tabak-popup { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #e67e22; color: white; padding: 30px 60px; font-size: 2.5em; font-weight: bold; border-radius: 25px; box-shadow: 0 0 50px rgba(0,0,0,0.8); border: 6px solid white; display: none; z-index: 6000; animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); text-align: center; width: auto; max-width: 90%; }
Â  Â  Â  Â  .popup-sub { font-size: 0.6em; display: block; margin-top: 10px; font-weight: normal; }
Â  Â  Â  Â  @keyframes popIn { from { transform: translate(-50%, -50%) scale(0); } to { transform: translate(-50%, -50%) scale(1); } }
Â  Â  Â  Â  #challenge-popup { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; padding: 25px 50px; font-size: 2em; font-weight: bold; border-radius: 20px; box-shadow: 0 0 40px rgba(0,0,0,0.7); border: 5px solid white; display: none; z-index: 6000; animation: popIn 0.3s ease-out; text-align: center; width: auto; max-width: 90%; }
Â  Â  Â  Â  .challenge-valid { background-color: #27ae60; } .challenge-invalid { background-color: #c0392b; }
Â  Â  Â  Â  .challenge-sub { font-size: 0.6em; display: block; margin-top: 5px; font-weight: normal; opacity: 0.9; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  #leave-modal .modal-box { border: 4px solid #c0392b; }
Â  Â  Â  Â  #mixer-info { font-size: 0.85em; background: #ecf0f1; padding: 10px; border-radius: 8px; margin: 10px 0; text-align: left; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* OYUN EKRANI MOBILE OPTIMIZASYONU - FIX (V6.8) */
Â  Â  Â  Â  @media screen and (max-width: 900px) {
Â  Â  Â  Â  Â  Â  body {Â 
Â  Â  Â  Â  Â  Â  Â  Â  height: 100vh;Â 
Â  Â  Â  Â  Â  Â  Â  Â  overflow: hidden; /* Scroll tamamen kapatÄ±ldÄ± */
Â  Â  Â  Â  Â  Â  Â  Â  background: #2c3e50;Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  .main-wrapper {Â 
Â  Â  Â  Â  Â  Â  Â  Â  display: grid; /* Flex yerine Grid */
Â  Â  Â  Â  Â  Â  Â  Â  grid-template-columns: 100%;
Â  Â  Â  Â  Â  Â  Â  Â  /* SatÄ±rlar: Title, Game(Kalan TÃ¼m Alan), Panel(Sabit), Butonlar(Sabit) */
Â  Â  Â  Â  Â  Â  Â  Â  /* FIX: Ãœst boÅŸluk eklendi (gap ile birlikte), Grid row'lar netleÅŸtirildi */
Â  Â  Â  Â  Â  Â  Â  Â  grid-template-rows: 40px 1fr 120px 40px;Â 
Â  Â  Â  Â  Â  Â  Â  Â  grid-template-areas:Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "logo"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "game"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "panel"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "buttons";
Â  Â  Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  Â  Â  height: 100vh;
Â  Â  Â  Â  Â  Â  Â  Â  padding: 15px 5px 5px 5px; /* FIX: Ãœstten 15px padding eklendi */
Â  Â  Â  Â  Â  Â  Â  Â  gap: 10px; /* Elemanlar arasÄ± boÅŸluk aÃ§Ä±ldÄ± */
Â  Â  Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  /* 1. SIRA: LOGO */
Â  Â  Â  Â  Â  Â  #brand-area {Â 
Â  Â  Â  Â  Â  Â  Â  Â  grid-area: logo;
Â  Â  Â  Â  Â  Â  Â  Â  padding: 4px 8px;Â 
Â  Â  Â  Â  Â  Â  Â  Â  flex-direction: row;Â 
Â  Â  Â  Â  Â  Â  Â  Â  align-items: center;Â 
Â  Â  Â  Â  Â  Â  Â  Â  gap: 5px;Â 
Â  Â  Â  Â  Â  Â  Â  Â  border-radius: 10px;
Â  Â  Â  Â  Â  Â  Â  Â  margin: 0; /* Margin sÄ±fÄ±rlandÄ±, grid gap kullanÄ±lÄ±yor */
Â  Â  Â  Â  Â  Â  Â  Â  height: 100%;Â 
Â  Â  Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  .brand-title { font-size: 1.1em; display: flex; gap: 5px; }Â 
Â  Â  Â  Â  Â  Â  .version { font-size: 0.6em; margin: 0; align-self: center; }Â 
Â  Â  Â  Â  Â  Â  .brand-sub { font-size: 0.7em; margin: 0; margin-left: auto; }

Â  Â  Â  Â  Â  Â  /* 2. SIRA: OYUN ALANI (ESNEK 1fr) */
Â  Â  Â  Â  Â  Â  .game-container {Â 
Â  Â  Â  Â  Â  Â  Â  Â  grid-area: game;
Â  Â  Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  Â  Â  height: 100%; /* BulunduÄŸu alanÄ± doldurur */
Â  Â  Â  Â  Â  Â  Â  Â  min-height: 0; /* Grid taÅŸmasÄ±nÄ± Ã¶nler */
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  /* FIX: Ä°Ã§ dÃ¼zen Flexbox'a Ã§evrildi */
Â  Â  Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  Â  Â  justify-content: space-between; /* ElemanlarÄ± yukarÄ±/orta/aÅŸaÄŸÄ± daÄŸÄ±t */
Â  Â  Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  Â  Â  padding: 5px 0;
Â  Â  Â  Â  Â  Â  Â  Â  overflow: hidden; /* TaÅŸmayÄ± engelle */
Â  Â  Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  /* FIX: Negatif marginler kaldÄ±rÄ±ldÄ±, taÅŸmalar Ã¶nlendi */
Â  Â  Â  Â  Â  Â  #top-area {Â 
Â  Â  Â  Â  Â  Â  Â  Â  height: auto;Â 
Â  Â  Â  Â  Â  Â  Â  Â  min-height: 80px;
Â  Â  Â  Â  Â  Â  Â  Â  width: 100%;Â 
Â  Â  Â  Â  Â  Â  Â  Â  transform: scale(0.80);Â 
Â  Â  Â  Â  Â  Â  Â  Â  transform-origin: center top;
Â  Â  Â  Â  Â  Â  Â  Â  margin: 0; /* Negatif margin iptal */
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  #play-area {Â 
Â  Â  Â  Â  Â  Â  Â  Â  height: auto;
Â  Â  Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  Â  Â  transform: scale(0.80);Â 
Â  Â  Â  Â  Â  Â  Â  Â  margin: 0; /* Negatif margin iptal */
Â  Â  Â  Â  Â  Â  Â  Â  flex-grow: 1; /* OrtayÄ± doldur */
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  #bottom-area {Â 
Â  Â  Â  Â  Â  Â  Â  Â  padding-bottom: 2px;
Â  Â  Â  Â  Â  Â  Â  Â  transform: scale(0.85);Â 
Â  Â  Â  Â  Â  Â  Â  Â  transform-origin: center bottom;
Â  Â  Â  Â  Â  Â  Â  Â  margin: 0; /* Negatif margin iptal */
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  .bot-wrapper { transform: scale(0.85); margin: 0; }Â 
Â  Â  Â  Â  Â  Â  .arrow-icon { font-size: 1.5em; position: absolute; top: 50%; transform: translateY(-50%); z-index: 15; }
Â  Â  Â  Â  Â  Â  #arrow-left { left: 5px; } #arrow-right { right: 5px; } #arrow-top-1, #arrow-top-2 { font-size: 1.5em; margin: 0; }
Â  Â  Â  Â  Â  Â  .flying-card { transform: scale(0.8); transform-origin: top left; }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  .card[data-val="+2"] .card-emoji { font-size: 2.2em !important; letter-spacing: -4px !important; }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  #player-hand {Â 
Â  Â  Â  Â  Â  Â  Â  Â  min-height: 80px;Â 
Â  Â  Â  Â  Â  Â  Â  Â  padding: 4px;Â 
Â  Â  Â  Â  Â  Â  Â  Â  gap: 3px;Â 
Â  Â  Â  Â  Â  Â  Â  Â  border-width: 2px;Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  .hand-normal .card, .hand-packed .card, .hand-super-packed .card { width: 40px; height: 60px; font-size: 0.5em; border-width: 1px; border-radius: 4px; }
Â  Â  Â  Â  Â  Â  .hand-normal .card-emoji, .hand-packed .card-emoji, .hand-super-packed .card-emoji { font-size: 1.6em; }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  #son-tabak-btn, #challenge-btn { padding: 8px 15px; font-size: 0.9em; margin-bottom: 2px; }
Â  Â  Â  Â  Â  Â  #son-tabak-popup, #challenge-popup { position: fixed !important; transform: translate(-50%, -50%) scale(0.7); }

Â  Â  Â  Â  Â  Â  /* 3. SIRA: PANEL (YAN YANA) */
Â  Â  Â  Â  Â  Â  .right-panel {Â 
Â  Â  Â  Â  Â  Â  Â  Â  grid-area: panel;
Â  Â  Â  Â  Â  Â  Â  Â  flex-direction: row; /* Yan yana */
Â  Â  Â  Â  Â  Â  Â  Â  height: 100%;Â 
Â  Â  Â  Â  Â  Â  Â  Â  gap: 5px;Â 
Â  Â  Â  Â  Â  Â  Â  Â  padding: 0;
Â  Â  Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  .flip-container { height: 100%; flex: 1; }
Â  Â  Â  Â  Â  Â  .chat-container { height: 100%; flex: 1; }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  /* Ä°Ã§erik Font AyarlarÄ± (KÃ¼Ã§Ã¼ltme) */
Â  Â  Â  Â  Â  Â  #score-table td { padding: 2px 4px; font-size: 0.7em; }
Â  Â  Â  Â  Â  Â  #system-log li { padding: 1px 0; font-size: 0.65em; }
Â  Â  Â  Â  Â  Â  #chat-messages { font-size: 0.65em !important; padding: 2px !important; gap: 1px !important; }
Â  Â  Â  Â  Â  Â  .chat-line { line-height: 1.1 !important; margin-bottom: 2px !important; }
Â  Â  Â  Â  Â  Â  .panel-header { font-size: 0.75em; padding: 3px; }
Â  Â  Â  Â  Â  Â  .chat-input-area { padding: 2px; }
Â  Â  Â  Â  Â  Â  #player-input { font-size: 0.7em; padding: 2px 5px; height: 25px; }
Â  Â  Â  Â  Â  Â  #send-btn { width: 25px; height: 25px; font-size: 1em; }

Â  Â  Â  Â  Â  Â  /* 4. SIRA: BUTONLAR (YAN YANA) */
Â  Â  Â  Â  Â  Â  .buttons-container {Â 
Â  Â  Â  Â  Â  Â  Â  Â  grid-area: buttons;
Â  Â  Â  Â  Â  Â  Â  Â  flex-direction: row;Â 
Â  Â  Â  Â  Â  Â  Â  Â  gap: 5px;Â 
Â  Â  Â  Â  Â  Â  Â  Â  padding: 0;Â 
Â  Â  Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  .game-btn { font-size: 0.8em; padding: 0; display: flex; align-items: center; justify-content: center; height: 100%; flex: 1; margin: 0; }
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body>
<canvas id="confetti-canvas"></canvas>

<div id="login-screen">
Â  Â  <div class="brand-corner">ğŸ”¥ Kalority</div>
Â  Â  <div class="rules-corner"><button class="icon-btn" onclick="openRules()">ğŸ“–</button></div>
Â  Â  <div class="production-corner">ONR Studios Production</div>

Â  Â  <div class="floating-bg" style="left:10%; animation-duration:12s; animation-delay: -5s;">ğŸ…</div>
Â  Â  <div class="floating-bg" style="left:30%; animation-duration:15s; animation-delay: -2s;">ğŸ¥”</div>
Â  Â  <div class="floating-bg" style="left:60%; animation-duration:10s; animation-delay: -8s;">ğŸ†</div>
Â  Â  <div class="floating-bg" style="left:80%; animation-duration:14s; animation-delay: -1s;">ğŸ¥¦</div>

Â  Â  <div class="login-content">
Â  Â  Â  Â  <div class="logo-container">
Â  Â  Â  Â  Â  Â  <span class="plate-anim">ğŸ½ï¸</span>
Â  Â  Â  Â  Â  Â  <div class="game-title-login">SON<br>TABAK</div>
Â  Â  Â  Â  Â  Â  <div class="online-stamp">ONLINE</div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="login-input-group">
Â  Â  Â  Â  Â  Â  <input type="text" id="username-in" class="styled-input" placeholder="AdÄ±nÄ± Yaz" maxlength="12">
Â  Â  Â  Â  Â  Â  <button class="login-btn-main" id="login-btn">MutfaÄŸa Gir</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<div id="new-lobby-screen">
Â  Â  <div class="brand-corner" style="position:fixed; top:15px; left:20px;">ğŸ”¥ Kalority</div>
Â  Â  <div class="rules-corner" style="position:fixed; top:15px; right:20px;"><button class="icon-btn" style="background:#333;" onclick="openRules()">ğŸ“–</button></div>
Â  Â  <div class="production-corner" style="position:fixed; bottom:10px; left:20px; color:#555;">ONR Studios Production</div>

Â  Â  <div class="lobby-grid">
Â  Â  Â  Â  <div class="lobby-col" id="col-create">
Â  Â  Â  Â  Â  Â  <div class="col-title" onclick="toggleLobbyTab(this)">Masa AÃ§ ğŸ›‹ï¸</div>
Â  Â  Â  Â  Â  Â  <div class="col-content create-form">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="room-name-in" class="styled-input" style="background:#f9f9f9; color:#333; border:1px solid #ddd; text-align:left;" placeholder="Masa AdÄ±">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" id="room-pass-in" class="styled-input" style="background:#f9f9f9; color:#333; border:1px solid #ddd; text-align:left;" placeholder="Åifre (Opsiyonel)">
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size:0.9em; font-weight:bold; margin-top:5px; color:#555;">Oyuncu SayÄ±sÄ±:</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="player-count-select">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="p-count-btn active" onclick="selectPCount(4)">4 KiÅŸi</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="p-count-btn disabled" style="pointer-events:none;">6 KiÅŸi (YakÄ±nda)</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <label class="mode-check">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" id="offline-mode-check" onchange="toggleOfflineMode(this)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-size:0.9em; font-weight:bold; color:#e67e22;">Tek KiÅŸilik Masa (Botlarla)</span>
Â  Â  Â  Â  Â  Â  Â  Â  </label>

Â  Â  Â  Â  Â  Â  Â  Â  <button class="login-btn-main" id="create-room-btn" style="padding:10px; margin-top:10px;">MasayÄ± Kur</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="lobby-col open-tab" id="col-rooms">
Â  Â  Â  Â  Â  Â  <div class="col-title" onclick="toggleLobbyTab(this)">Aktif Masalar ğŸ½ï¸</div>
Â  Â  Â  Â  Â  Â  <div class="col-content room-scroll" id="room-list-container">
Â  Â  Â  Â  Â  Â  Â  Â  <div style="text-align:center; color:#777; margin-top:20px;">Masalar aranÄ±yor...</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="lobby-col players-col" id="col-players">
Â  Â  Â  Â  Â  Â  <div class="col-title" onclick="toggleLobbyTab(this)">Mutfaktakiler ğŸ‘¨â€ğŸ³</div>
Â  Â  Â  Â  Â  Â  <div class="col-content player-list-scroll" id="online-player-list">
Â  Â  Â  Â  Â  Â  Â  Â  <div style="text-align:center; color:#777;">YÃ¼kleniyor...</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="lobby-chat-wrapper">
Â  Â  Â  Â  Â  Â  <div style="font-weight:bold; font-size:0.9em; color:#555; margin-bottom:5px;">Lobi Sohbeti ğŸ’¬</div>
Â  Â  Â  Â  Â  Â  <div id="lobby-chat-msgs" class="l-chat-msgs"></div>
Â  Â  Â  Â  Â  Â  <div class="l-chat-input">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="lobby-chat-in" class="l-chat-in" placeholder="Lobiye yaz..." onkeypress="handleLobbyChatKey(event)">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="room-action-btn" onclick="sendLobbyChat()">GÃ¶nder</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<div id="waiting-room-overlay" class="modal">
Â  Â  <div class="modal-box">
Â  Â  Â  Â  <h3 id="wr-room-name">Oda: ...</h3>
Â  Â  Â  Â  <p>Oyuncular bekleniyor (<span id="wr-count">0</span>/4)</p>
Â  Â  Â  Â  <ul id="wr-player-list" class="player-list"></ul>
Â  Â  Â  Â  <div id="wr-host-controls" style="display:none;">
Â  Â  Â  Â  Â  Â  <p style="font-size:0.8em; color:#e67e22;">Eksik oyuncular yerine Bot (ğŸ¤–) eklenecek.</p>
Â  Â  Â  Â  Â  Â  <button class="game-btn btn-blue" id="start-game-btn">Oyunu BaÅŸlat ğŸš€</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="wr-guest-controls">
Â  Â  Â  Â  Â  Â  <p>Host'un baÅŸlatmasÄ± bekleniyor...</p>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <br>
Â  Â  Â  Â  <button class="game-btn btn-red" id="leave-room-btn">Ã‡Ä±kÄ±ÅŸ</button>
Â  Â  </div>
</div>

<div id="leave-modal" class="modal">
Â  Â  <div class="modal-box">
Â  Â  Â  Â  <h3>ğŸš¨ Oyundan Ã‡Ä±k?</h3>
Â  Â  Â  Â  <p>Oyundan ayrÄ±lmak istediÄŸine emin misin?</p>
Â  Â  Â  Â  <br>
Â  Â  Â  Â  <div style="display:flex; gap:10px; width:100%; justify-content:center;">
Â  Â  Â  Â  Â  Â  <button class="game-btn btn-red" onclick="confirmLeaveGame()">Evet, Lobiye DÃ¶n</button>
Â  Â  Â  Â  Â  Â  <button class="game-btn btn-blue" onclick="document.getElementById('leave-modal').style.display='none'">Ä°ptal</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<div class="main-wrapper" id="main-game-wrapper">
Â  Â  <div id="brand-area">
Â  Â  Â  Â  <div class="brand-title">ğŸ½ï¸ Son Tabak <span class="version">v6.8 UI</span></div>
Â  Â  Â  Â  <div class="brand-sub">ğŸ”¥Kalority</div>
Â  Â  </div>
Â  Â  <div class="game-container">
Â  Â  Â  Â  <div id="arrow-left" class="arrow-icon">â¬†ï¸</div>
Â  Â  Â  Â  <div id="arrow-right" class="arrow-icon">â¬‡ï¸</div>
Â  Â  Â  Â  <div id="top-area">
Â  Â  Â  Â  Â  Â  <div class="bot-wrapper" id="bot1-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="bot-name" id="bot1-name">Oyuncu 2</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="bot-stack-visual" id="bot1-stack"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="chat-bubble" id="bot1-chat"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="arrow-top-1" class="arrow-top-static">â¡ï¸</div>
Â  Â  Â  Â  Â  Â  <div class="bot-wrapper" id="bot2-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="bot-name" id="bot2-name">Oyuncu 3</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="bot-stack-visual" id="bot2-stack"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="chat-bubble" id="bot2-chat"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="arrow-top-2" class="arrow-top-static">â¡ï¸</div>
Â  Â  Â  Â  Â  Â  <div class="bot-wrapper" id="bot3-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="bot-name" id="bot3-name">Oyuncu 4</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="bot-stack-visual" id="bot3-stack"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="chat-bubble" id="bot3-chat"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="play-area">
Â  Â  Â  Â  Â  Â  <div id="draw-pile" class="card card-back-style" onclick="playerDrawCard()">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="draw-counter">+1</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="penalty-badge">+0</div>Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div id="deck-count" style="position:absolute; bottom:10px; color:white; font-size:1.5em; text-shadow:1px 1px 2px #000;">0</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="discard-pile"></div>
Â  Â  Â  Â  Â  Â  <div id="son-tabak-popup">SON TABAK!<span id="son-tabak-who" class="popup-sub"></span></div>
Â  Â  Â  Â  Â  Â  <div id="challenge-popup"><span id="challenge-who"></span><span id="challenge-result" class="challenge-sub"></span></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="bottom-area">
Â  Â  Â  Â  Â  Â  <div id="son-tabak-container">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="son-tabak-btn" onclick="playerSaySonTabak()">SON TABAK!</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="challenge-btn" onclick="challengePreviousPlayer()" disabled>âœ‹ Ä°TÄ°RAZ ET!</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="player-hand" class="hand-normal"></div>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div class="right-panel">
Â  Â  Â  Â  <div class="flip-container" onclick="toggleInfoView(this)">
Â  Â  Â  Â  Â  Â  <div class="flip-inner">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flip-front">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="panel-header"><span>ğŸ† Puan</span><span class="panel-hint">ğŸ–±ï¸ Log</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <table id="score-table"><tbody></tbody></table>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flip-back">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="panel-header" style="background:#7f8c8d;"><span>ğŸ“ Log</span><span class="panel-hint">ğŸ–±ï¸ Puan</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <ul id="system-log"></ul>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="chat-container">
Â  Â  Â  Â  Â  Â  <div id="chat-messages"></div>
Â  Â  Â  Â  Â  Â  <div class="chat-input-area">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="player-input" placeholder="Yaz..." onkeypress="handleChatKey(event)">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="send-btn" onclick="playerSendMessage()">â¤</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div class="buttons-container">
Â  Â  Â  Â  <button class="game-btn btn-dark" onclick="openRules()">ğŸ“– Kurallar</button>
Â  Â  Â  Â  <button class="game-btn btn-blue" onclick="openPatternModal()">ğŸ¨ Desen</button>
Â  Â  Â  Â  <button class="game-btn btn-red" onclick="leaveGame()">âŒ Ã‡Ä±kÄ±ÅŸ</button>
Â  Â  </div>
</div>

<div id="rules-modal" class="modal">
Â  Â  <div class="modal-box" style="text-align:left; max-height:80vh; overflow-y:auto;">
Â  Â  Â  Â  <h3>ğŸ“– NasÄ±l OynanÄ±r?</h3>
Â  Â  Â  Â  <p style="font-size:0.9em;">
Â  Â  Â  Â  Â  Â  1. AmaÃ§ elindeki kartlarÄ± bitirmektir.<br>
Â  Â  Â  Â  Â  Â  2. Yerdeki kart ile aynÄ± renk veya aynÄ± sayÄ±/sembol atabilirsin.<br>
Â  Â  Â  Â  Â  Â  3. Ã–zel kartlar (Mikser, Sofra, GÃ¼veÃ§) rengi deÄŸiÅŸtirir veya oyunun akÄ±ÅŸÄ±nÄ± bozar.<br>
Â  Â  Â  Â  Â  Â  4. Elinde 2 kart varken hamle yapÄ±p 1 karta dÃ¼ÅŸeceÄŸin zaman "SON TABAK" demeyi unutma!<br>
Â  Â  Â  Â  Â  Â  5. Unutanlara "Ä°TÄ°RAZ ET" butonu ile ceza verebilirsin.<br>
Â  Â  Â  Â  Â  Â  6. Bol ÅŸans! ğŸ…ğŸ¥¦
Â  Â  Â  Â  </p>
Â  Â  Â  Â  <button class="game-btn btn-blue" onclick="document.getElementById('rules-modal').style.display='none'">AnladÄ±m</button>
Â  Â  </div>
</div>

<div id="pattern-modal" class="modal">
Â  Â  <div class="modal-box">
Â  Â  Â  Â  <h3>Kart Deseni</h3>
Â  Â  Â  Â  <div class="pattern-grid" id="pattern-grid"></div>
Â  Â  Â  Â  <br><button class="game-btn btn-blue" onclick="closePatternModal()">Kapat</button>
Â  Â  </div>
</div>

<div id="color-modal" class="modal">
Â  Â  <div class="modal-box">
Â  Â  Â  Â  <h3>Renk SeÃ§</h3>
Â  Â  Â  Â  <div class="color-picker">
Â  Â  Â  Â  Â  Â  <div class="color-opt bg-red" onclick="resolveColor('red')"></div>
Â  Â  Â  Â  Â  Â  <div class="color-opt bg-green" onclick="resolveColor('green')"></div>
Â  Â  Â  Â  Â  Â  <div class="color-opt bg-yellow" onclick="resolveColor('yellow')"></div>
Â  Â  Â  Â  Â  Â  <div class="color-opt bg-purple" onclick="resolveColor('purple')"></div>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<div id="dir-modal" class="modal">
Â  Â  <div class="modal-box">
Â  Â  Â  Â  <h3>YÃ¶n SeÃ§ (Mikser)</h3>
Â  Â  Â  Â  <p id="dir-text" style="font-size:0.8em; margin:5px 0;">Eller hangi yÃ¶ne kaysÄ±n?</p>
Â  Â  Â  Â  <div id="mixer-info"></div>
Â  Â  Â  Â  <div class="color-picker">
Â  Â  Â  Â  Â  Â  <button class="game-btn btn-blue" onclick="resolveDirection(1)">â¡ï¸ Saat</button>
Â  Â  Â  Â  Â  Â  <button class="game-btn btn-blue" onclick="resolveDirection(-1)">â¬…ï¸ Ters</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<div id="end-modal" class="modal">
Â  Â  <div class="modal-box" style="max-width: 400px;">
Â  Â  Â  Â  <h2 id="winner-text"></h2>
Â  Â  Â  Â  <div id="ai-summary" style="font-style:italic; font-size:0.9em; margin:15px 0; color:#555; border-top:1px solid #eee; border-bottom:1px solid #eee; padding:10px;"></div>
Â  Â  Â  Â  <div id="final-scores"></div>
Â  Â  Â  Â  <br>
Â  Â  Â  Â  <div style="display:flex; gap:15px; width:100%;">
Â  Â  Â  Â  Â  Â  <button id="end-continue-btn" class="game-btn btn-blue" style="flex:1;" onclick="toggleReadyState()">Devam Et â³</button>
Â  Â  Â  Â  Â  Â  <button id="host-start-btn" class="game-btn btn-green" style="flex:1; display:none;" onclick="nextRound()">YENÄ° EL BAÅLAT</button>
Â  Â  Â  Â  Â  Â  <button class="game-btn btn-red" style="flex:1;" onclick="leaveGame()">Ã‡Ä±kÄ±ÅŸ</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<div id="toast" style="position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#333; color:#fff; padding:10px 20px; border-radius:20px; display:none; z-index:5000;"></div>

<script>
/* --- MOBILE UI LOGIC --- */
function toggleLobbyTab(element) {
Â  Â  if (window.innerWidth > 900) return; // Sadece mobilde Ã§alÄ±ÅŸsÄ±n

Â  Â  const parent = element.parentElement;
Â  Â  const allCols = document.querySelectorAll('.lobby-col');

Â  Â  // EÄŸer zaten aÃ§Ä±ksa kapat
Â  Â  if (parent.classList.contains('open-tab')) {
Â  Â  Â  Â  parent.classList.remove('open-tab');
Â  Â  } else {
Â  Â  Â  Â  // DeÄŸilse, diÄŸerlerini kapat ve bunu aÃ§
Â  Â  Â  Â  allCols.forEach(col => col.classList.remove('open-tab'));
Â  Â  Â  Â  allCols.forEach(col => col.querySelector('.col-content').style.opacity = '0');
Â  Â  Â  Â Â 
Â  Â  Â  Â  parent.classList.add('open-tab');
Â  Â  Â  Â  setTimeout(() => parent.querySelector('.col-content').style.opacity = '1', 50);
Â  Â  }
}

/* --- ANIMATION & CONFIG CONSTANTS --- */
const ANIM_CONFIG = {
Â  Â  FLY_DURATION: 1000,Â  Â  Â Â 
Â  Â  FLY_BUFFER: 1100,Â  Â  Â  Â Â 
Â  Â  DRAW_INTERVAL: 600,Â  Â  Â Â 
Â  Â  INITIAL_DEAL: 250,Â  Â  Â  Â Â 
Â  Â  TOAST: 2000,Â  Â  Â  Â  Â  Â  Â 
Â  Â  POPUP: 3000,Â  Â  Â  Â  Â  Â  Â 
Â  Â  BOT_THINK: 800,Â  Â  Â  Â  Â  Â Â 
Â  Â  HEARTBEAT_MS: 5000,Â  Â  Â  Â Â 
Â  Â  HOST_TIMEOUT: 15000,Â  Â  Â 
Â  Â  AFK_TIMEOUT: 60000,Â  Â  Â  Â Â 
Â  Â  BOT_WATCHDOG: 3000Â  Â  Â  Â Â 
};

/* --- CARD NAMES MAPPING --- */
const CARD_NAMES = {
Â  Â  '+1': 'ğŸ“¦ +1',
Â  Â  '+2': 'ğŸ“¦ğŸ“¦ +2',
Â  Â  'Reverse': 'â™»ï¸ Geri DÃ¶nÃ¼ÅŸÃ¼m',
Â  Â  'Block': 'ğŸ”ª BÄ±Ã§ak',
Â  Â  'Wild': 'GÃ¼veÃ§',
Â  Â  'Wild Anti-Draw': 'ğŸ§» Tuvalet KaÄŸÄ±dÄ±',
Â  Â  'Wild Pot': 'ğŸ² DÃ¼dÃ¼klÃ¼ Tencere',
Â  Â  'Wild Table': 'ğŸ½ï¸ Sofra',
Â  Â  'Wild Mixer': 'ğŸŒªï¸ Mikser',
Â  Â  'Wild Meze': 'ğŸ± Meze'
};

/* --- PATTERNS --- */
const CARD_PATTERNS = [
Â  Â  'linear-gradient(135deg, #e67e22 0%, #d35400 100%)', // Default Orange
Â  Â  'repeating-linear-gradient(45deg, #e67e22, #e67e22 10px, #d35400 10px, #d35400 20px)',
Â  Â  'radial-gradient(circle, #e67e22 20%, #d35400 90%)',
Â  Â  'conic-gradient(#e67e22, #d35400, #e67e22)',
Â  Â  'linear-gradient(135deg, #2c3e50 0%, #000000 100%)', // Dark 1
Â  Â  'repeating-linear-gradient(45deg, #2c3e50, #2c3e50 10px, #000000 10px, #000000 20px)',
Â  Â  'radial-gradient(circle, #7f8c8d 20%, #2c3e50 90%)',
Â  Â  'conic-gradient(#34495e, #000000, #34495e)'
];
let currentPattern = CARD_PATTERNS[0];

/* --- FIREBASE INIT --- */
const firebaseConfig = {
Â  apiKey: "AIzaSyDqyHqluehXJHt4xeanl51LRVG4AeQ3Ijk",
Â  authDomain: "son-tabak.firebaseapp.com",
Â  databaseURL: "https://son-tabak-default-rtdb.europe-west1.firebasedatabase.app",
Â  projectId: "son-tabak",
Â  storageBucket: "son-tabak.firebasestorage.app",
Â  messagingSenderId: "994436192152",
Â  appId: "1:994436192152:web:35d17d0dbb1d5d0015fded"
};

let app, db, auth;
try {
Â  Â  app = firebase.initializeApp(firebaseConfig);
Â  Â  db = firebase.firestore();
Â  Â  auth = firebase.auth();
Â  Â  console.log("Firebase Init OK");
} catch(e) {
Â  Â  alert("Firebase HatasÄ±: " + e.message);
}

/* --- SES VE CHAT --- */
const AudioContext = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioContext();

const SoundFX = {
Â  Â  playTone: (freq, type, duration, rampTo = 0.001) => {
Â  Â  Â  Â  if(audioCtx.state === 'suspended') audioCtx.resume();
Â  Â  Â  Â  const osc = audioCtx.createOscillator();
Â  Â  Â  Â  const gain = audioCtx.createGain();
Â  Â  Â  Â  osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
Â  Â  Â  Â  gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
Â  Â  Â  Â  gain.gain.exponentialRampToValueAtTime(rampTo, audioCtx.currentTime + duration);
Â  Â  Â  Â  osc.connect(gain); gain.connect(audioCtx.destination);
Â  Â  Â  Â  osc.start(); osc.stop(audioCtx.currentTime + duration);
Â  Â  },
Â  Â  playCardSnap: () => SoundFX.playTone(800, 'sine', 0.1),
Â  Â  playDraw: () => SoundFX.playTone(400, 'triangle', 0.15),
Â  Â  playBlock: () => { SoundFX.playTone(1500, 'sawtooth', 0.1); setTimeout(() => SoundFX.playTone(2000, 'sine', 0.3), 50); },
Â  Â  playReverse: () => { if(audioCtx.state === 'suspended') audioCtx.resume(); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.frequency.setValueAtTime(200, audioCtx.currentTime); osc.frequency.linearRampToValueAtTime(800, audioCtx.currentTime + 0.3); gain.gain.setValueAtTime(0.1, audioCtx.currentTime); gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.3); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.3); },
Â  Â  playWild: () => { [300, 400, 500, 600, 800].forEach((f, i) => setTimeout(() => SoundFX.playTone(f, 'sine', 0.2), i*50)); },
Â  Â  playBad: () => { SoundFX.playTone(150, 'sawtooth', 0.2); setTimeout(() => SoundFX.playTone(120, 'sawtooth', 0.4), 100); },
Â  Â  playError: () => { SoundFX.playTone(100, 'square', 0.2); },
Â  Â  playFanfare: () => { [523, 659, 783, 1046].forEach((f, i) => setTimeout(() => SoundFX.playTone(f, 'square', 0.4), i * 150)); },
Â  Â  playUno: () => SoundFX.playTone(1200, 'sine', 0.5)
};

const CHAT_POOL = {
Â  Â  "Agresif": { "start_good": ["DaÄŸÄ±lÄ±n!", "AcÄ±mam."], "block": ["GeÃ§!", "Bekle!"], "plus2": ["Al bakalÄ±m!", "+2 cnm"], "wild": ["Ben ne dersem o!"], "draw_many": ["DÃ¼kkanÄ± aldÄ±m!", "Bu ne?!"], "win": ["Ezdim!", "Kral benim!"], "fail": ["Olamaz!", "Hile!"] },
Â  Â  "Stratejik": { "start_good": ["Plan hazÄ±r."], "block": ["SÄ±radaki."], "plus2": ["Stratejik hamle."], "wild": ["Renk deÄŸiÅŸimi."], "draw_many": ["Plan deÄŸiÅŸti."], "win": ["Matematik kazandÄ±."], "fail": ["Hesap hatasÄ±."] },
Â  Â  "Panik Atak": { "start_good": ["HeyecanlÄ±yÄ±m!"], "block": ["Pardon!", "Ã–zÃ¼r!"], "plus2": ["KÄ±zma n'olur!"], "wild": ["Ay ne seÃ§sem?"], "draw_many": ["BoÄŸuluyorum!", "Ä°mdat!"], "win": ["Ben mi kazandÄ±m?"], "fail": ["GÃ¶rmedim!"] },
Â  Â  "Rahat": { "start_good": ["AkarÄ± var."], "block": ["Soluklan.", "YavaÅŸ."], "plus2": ["Hediye.", "Yorma kendini."], "wild": ["DeÄŸiÅŸiklik iyidir."], "draw_many": ["Ooo bana girdi.", "Nasip."], "win": ["Tertemiz.", "KolaydÄ±."], "fail": ["DalmÄ±ÅŸÄ±m."] },
Â  Â  "GÄ±cÄ±k": { "start_good": ["Ezikler."], "block": ["Kudur!", "Zaa!"], "plus2": ["Beter ol.", "AÄŸlama."], "wild": ["Biat edin!"], "draw_many": ["Hile var!", "Of ya."], "win": ["Ã‡ok kolaysÄ±nÄ±z."], "fail": ["Ã–nemli deÄŸil."] },
Â  Â  "Dengeli": { "start_good": ["BaÅŸlayalÄ±m."], "block": ["GeÃ§ bakalÄ±m."], "plus2": ["+2 Ã§ek."], "wild": ["Renk deÄŸiÅŸsin."], "draw_many": ["BayaÄŸÄ± Ã§ektim."], "win": ["GÃ¼zel oyun."], "fail": ["TÃ¼h."] }
};

let myUid = null; let myName = ""; let currentRoomId = null; let isHost = false;
let roomUnsubscribe = null; let myPlayerIdx = -1;
let localPlayers = []; let lastGameState = null; let lastChatTs = 0; let amIReady = false; let heartbeatInterval = null;
let actionQueue = []; let isProcessingQueue = false;
let localSaidSonTabak = false;Â 
let isDealing = false;
let previousPlayersList = []; // LOG ICIN
let isOfflineMode = false; // OFFLINE MODE FLAG

/* --- LOGIC --- */
auth.onAuthStateChanged((user) => { if (user) myUid = user.uid; });

// 4 vs 6 Selection
let selectedPCount = 4;
function selectPCount(n) { selectedPCount = n; document.querySelectorAll('.p-count-btn').forEach(b => b.classList.remove('active')); event.target.classList.add('active'); }

// FIX: Offline Mode Toggle
function toggleOfflineMode(el) {
Â  Â  const isChecked = el.checked;
Â  Â  const nameIn = document.getElementById('room-name-in');
Â  Â  const passIn = document.getElementById('room-pass-in');
Â  Â Â 
Â  Â  nameIn.disabled = isChecked;
Â  Â  passIn.disabled = isChecked;
Â  Â Â 
Â  Â  if(isChecked) {
Â  Â  Â  Â  nameIn.value = "Tek KiÅŸilik Masa";
Â  Â  Â  Â  passIn.value = "";
Â  Â  } else {
Â  Â  Â  Â  nameIn.value = "";
Â  Â  }
}

document.getElementById('login-btn').addEventListener('click', () => {
Â  Â  const name = document.getElementById('username-in').value.trim();
Â  Â  if(!name) return alert("LÃ¼tfen bir isim gir!");
Â  Â  document.getElementById('login-btn').innerText = "MutfaÄŸa Giriliyor...";
Â  Â Â 
Â  Â  // FIX: Mevcut oturumu kontrol et (Duplikasyonu Ã¶nlemek iÃ§in)
Â  Â  const proceedLogin = () => {
Â  Â  Â  Â  myName = name;
Â  Â  Â  Â  if(audioCtx.state === 'suspended') audioCtx.resume();
Â  Â  Â  Â  document.getElementById('login-screen').style.display = 'none';
Â  Â  Â  Â  document.getElementById('new-lobby-screen').style.display = 'flex';
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Lobi BaÅŸlangÄ±Ã§ Ä°ÅŸlemleri
Â  Â  Â  Â  listenRooms();
Â  Â  Â  Â  listenLobbyChat();
Â  Â  Â  Â  startPresence();
Â  Â  };

Â  Â  if (auth.currentUser) {
Â  Â  Â  Â  myUid = auth.currentUser.uid;
Â  Â  Â  Â  proceedLogin();
Â  Â  } else {
Â  Â  Â  Â  auth.signInAnonymously()
Â  Â  Â  Â  Â  Â  .then(() => {
Â  Â  Â  Â  Â  Â  Â  Â  proceedLogin();
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  .catch((e) => {
Â  Â  Â  Â  Â  Â  Â  Â  alert("GiriÅŸ HatasÄ±: " + e.message);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('login-btn').innerText = "MutfaÄŸa Gir";
Â  Â  Â  Â  Â  Â  });
Â  Â  }
});

/* --- LOBBY LOGIC --- */
function startPresence() {
Â  Â  // Kendini online listesine ekle
Â  Â  const updatePresence = () => {
Â  Â  Â  Â  if(!myUid) return;
Â  Â  Â  Â  db.collection('online_users').doc(myUid).set({ name: myName, status: 'lobby', lastSeen: Date.now() }, {merge:true});
Â  Â  };
Â  Â  updatePresence();
Â  Â  setInterval(updatePresence, 10000);

Â  Â  // Listeyi Dinle
Â  Â  db.collection('online_users').orderBy('lastSeen', 'desc').limit(20).onSnapshot(snap => {
Â  Â  Â  Â  const list = document.getElementById('online-player-list'); list.innerHTML = '';
Â  Â  Â  Â  const now = Date.now();
Â  Â  Â  Â  snap.forEach(doc => {
Â  Â  Â  Â  Â  Â  const d = doc.data();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // FIX: Aktif olmayan oyuncularÄ± Firebaseden sil
Â  Â  Â  Â  Â  Â  if(now - d.lastSeen > 300000) { // 5dk inactive
Â  Â  Â  Â  Â  Â  Â  Â  doc.ref.delete().catch(()=>{}); // Delete from firebase
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  let stClass = 'pst-lobby';
Â  Â  Â  Â  Â  Â  if(now - d.lastSeen > 30000) stClass = 'pst-disc'; // Disconnected
Â  Â  Â  Â  Â  Â  else if(d.status === 'playing') stClass = 'pst-game';
Â  Â  Â  Â  Â  Â  else if(d.status === 'waiting') stClass = 'pst-wait';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  list.innerHTML += `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="lobby-player-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-status-dot ${stClass}"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-weight:${d.name===myName?'bold':'normal'}">${d.name}</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  });
Â  Â  });
}

function listenLobbyChat() {
Â  Â  db.collection('lobby_chat').orderBy('ts', 'desc').limit(50).onSnapshot(snap => {
Â  Â  Â  Â  const d = document.getElementById('lobby-chat-msgs');
Â  Â  Â  Â  d.innerHTML = '';
Â  Â  Â  Â  let msgs = [];
Â  Â  Â  Â  snap.forEach(s => msgs.push(s.data()));
Â  Â  Â  Â  msgs.reverse().forEach(m => {
Â  Â  Â  Â  Â  Â  d.innerHTML += `<div style="padding:2px 0;"><span style="font-weight:bold; color:#e67e22;">${m.sender}:</span> ${m.msg}</div>`;
Â  Â  Â  Â  });
Â  Â  Â  Â  d.scrollTop = d.scrollHeight;
Â  Â  });
}
function sendLobbyChat() {
Â  Â  const i = document.getElementById('lobby-chat-in'); const v = i.value.trim();
Â  Â  if(!v) return;
Â  Â  db.collection('lobby_chat').add({ sender: myName, msg: v, ts: Date.now() });
Â  Â  i.value = '';
Â  Â Â 
Â  Â  // FIX: Chat Limit Cleanup (50 mesajdan fazlasÄ±nÄ± sil)
Â  Â  db.collection('lobby_chat').orderBy('ts', 'desc').get().then(snap => {
Â  Â  Â  Â  if(snap.size > 50) {
Â  Â  Â  Â  Â  Â  const batch = db.batch();
Â  Â  Â  Â  Â  Â  snap.docs.slice(50).forEach(doc => batch.delete(doc.ref));
Â  Â  Â  Â  Â  Â  batch.commit().catch(e => console.log("Chat cleanup error", e));
Â  Â  Â  Â  }
Â  Â  });
}
function handleLobbyChatKey(e) { if(e.key === 'Enter') sendLobbyChat(); }

function listenRooms() {
Â  Â  const list = document.getElementById('room-list-container');
Â  Â  db.collection("rooms").onSnapshot((snapshot) => {
Â  Â  Â  Â  list.innerHTML = "";
Â  Â  Â  Â  if(snapshot.empty) list.innerHTML = "<div style='text-align:center;color:#777; margin-top:20px;'>AÃ§Ä±k masa yok, Ã§ek bir sandalye!</div>";
Â  Â  Â  Â  const now = Date.now();
Â  Â  Â  Â  snapshot.forEach(docSnap => {
Â  Â  Â  Â  Â  Â  const r = docSnap.data();
Â  Â  Â  Â  Â  Â  if (r.lastActive && now - r.lastActive > 60000) { docSnap.ref.delete().catch(() => {}); return; }
Â  Â  Â  Â  Â  Â  if(r.status === 'finished') return;Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let realHumans = r.players.filter(p => !p.isBot).length;
Â  Â  Â  Â  Â  Â  let dotClass = r.status === 'playing' ? (realHumans >= 4 ? 'st-red' : 'st-yellow') : 'st-green';
Â  Â  Â  Â  Â  Â  let statusText = r.status === 'playing' ? 'OynanÄ±yor' : 'Bekliyor';
Â  Â  Â  Â  Â  Â  let botCount = r.players.filter(p => p.isBot).length;
Â  Â  Â  Â  Â  Â  let joinText = r.hasPassword ? "ğŸ”’ Otur" : "Otur";
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (r.status === 'playing' && botCount === 0) joinText = "Dolu";

Â  Â  Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  Â  Â  div.className = 'lobby-room-item';
Â  Â  Â  Â  Â  Â  div.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="room-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="room-status-dot ${dotClass}"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="room-name-txt">${r.name}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="room-count-pill">${realHumans}/4</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (joinText !== "Dolu") {
Â  Â  Â  Â  Â  Â  Â  Â  const joinBtn = document.createElement('button');
Â  Â  Â  Â  Â  Â  Â  Â  joinBtn.className = 'room-action-btn'; joinBtn.innerText = joinText;
Â  Â  Â  Â  Â  Â  Â  Â  joinBtn.onclick = () => joinRoom(docSnap.id, r.hasPassword);
Â  Â  Â  Â  Â  Â  Â  Â  div.appendChild(joinBtn);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  list.appendChild(div);
Â  Â  Â  Â  });
Â  Â  });
}

document.getElementById('create-room-btn').addEventListener('click', () => {
Â  Â  const isOffline = document.getElementById('offline-mode-check').checked;
Â  Â Â 
Â  Â  // OFFLINE MODE BAÅLATMA
Â  Â  if (isOffline) {
Â  Â  Â  Â  startOfflineGame("Tek KiÅŸilik Masa");
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  // ONLINE MODE BAÅLATMA
Â  Â  const rName = document.getElementById('room-name-in').value.trim() || `${myName}'in MasasÄ±`;
Â  Â  const rPass = document.getElementById('room-pass-in').value.trim();

Â  Â  db.collection("rooms").add({
Â  Â  Â  Â  name: rName, password: rPass, hasPassword: !!rPass, hostId: myUid, status: 'waiting', lastActive: Date.now(),
Â  Â  Â  Â  players: [{ uid: myUid, name: myName, isBot: false, score: 0, hand: [], isReady: false, saidSonTabak: false, challengeUsed: false, personality: 'Dengeli', lastSeen: Date.now() }],
Â  Â  Â  Â  gameState: null
Â  Â  }).then(ref => {
Â  Â  Â  Â  currentRoomId = ref.id; isHost = true; isOfflineMode = false;
Â  Â  Â  Â  db.collection('online_users').doc(myUid).update({status: 'waiting'});
Â  Â  Â  Â  enterWaitingRoom(rName);
Â  Â  });
});

/* --- OFFLINE MODE LOGIC --- */
function startOfflineGame(rName) {
Â  Â  isOfflineMode = true;
Â  Â  currentRoomId = "offline_room";
Â  Â  isHost = true;
Â  Â  myName = myName || "Ben";
Â  Â  myUid = "local_player";
Â  Â Â 
Â  Â  // Hide Lobby, Show Game
Â  Â  document.getElementById('new-lobby-screen').style.display = 'none';
Â  Â  document.getElementById('main-game-wrapper').style.display = 'grid'; // Grid is better for PC, Flex handled in CSS for mobile

Â  Â  // Mock Players
Â  Â  localPlayers = [
Â  Â  Â  Â  { uid: myUid, name: myName, isBot: false, score: 0, hand: [], isReady: true, saidSonTabak: false, challengeUsed: false, personality: 'Dengeli' },
Â  Â  Â  Â  { uid: 'bot_1', name: 'ğŸ¤– Rifu', isBot: true, score: 0, hand: [], isReady: true, saidSonTabak: false, challengeUsed: false, personality: 'Agresif' },
Â  Â  Â  Â  { uid: 'bot_2', name: 'ğŸ¤– Utku', isBot: true, score: 0, hand: [], isReady: true, saidSonTabak: false, challengeUsed: false, personality: 'Stratejik' },
Â  Â  Â  Â  { uid: 'bot_3', name: 'ğŸ¤– Atlas', isBot: true, score: 0, hand: [], isReady: true, saidSonTabak: false, challengeUsed: false, personality: 'Rahat' }
Â  Â  ];
Â  Â Â 
Â  Â  // Initialize Game
Â  Â  startGameLogic(localPlayers);
}

function startGameLogic(players) {
Â  Â  let finalPlayers = shuffleDeck([...players]);
Â  Â  myPlayerIdx = finalPlayers.findIndex(p => p.uid === myUid);
Â  Â Â 
Â  Â  const newDeck = createFullDeck();
Â  Â  const hands = [[], [], [], []];
Â  Â  for(let i=0; i<7; i++) { for(let p=0; p<4; p++) hands[p].push(newDeck.pop()); }
Â  Â  finalPlayers.forEach((p, i) => p.hand = hands[i]);
Â  Â Â 
Â  Â  let first = newDeck.pop();
Â  Â  while(first.color === 'wild' || first.type === 'action') { newDeck.unshift(first); first = newDeck.pop(); }
Â  Â Â 
Â  Â  const initialState = {
Â  Â  Â  Â  deck: newDeck, discardPile: [first], currentPlayer: Math.floor(Math.random()*4), direction: 1, drawStack: 0, gameActive: true,
Â  Â  Â  Â  lastAction: { type: 'start', timestamp: Date.now() }, vulnerablePlayerIdx: -1, playerColors: shuffleDeck(['#c0392b', '#f1c40f', '#8e44ad', '#27ae60']),
Â  Â  Â  Â  lastChat: { sender: "Sistem", msg: "Oyun BaÅŸladÄ±! (Tek KiÅŸilik)", ts: Date.now(), isSystem: true }, hasDrawn: false
Â  Â  };

Â  Â  // Initialize Local State
Â  Â  gamePlayers = finalPlayers;
Â  Â Â 
Â  Â  // Trigger Sync manually
Â  Â  syncGameLoop({ players: finalPlayers, gameState: initialState });
}

/* --- COMMON GAME FUNCTIONS --- */
function joinRoom(roomId, hasPass) {
Â  Â  if(hasPass) {
Â  Â  Â  Â  const p = prompt("Oda Åifresi:"); if(p === null) return;
Â  Â  Â  Â  db.collection("rooms").doc(roomId).get().then(doc => {
Â  Â  Â  Â  Â  Â  Â if(doc.data().password !== p) return alert("YanlÄ±ÅŸ Åifre!");
Â  Â  Â  Â  Â  Â  Â proceedJoin(roomId);
Â  Â  Â  Â  });
Â  Â  } else proceedJoin(roomId);
}

function proceedJoin(roomId) {
Â  Â  const roomRef = db.collection("rooms").doc(roomId);
Â  Â  roomRef.get().then(doc => {
Â  Â  Â  Â  if(!doc.exists) return alert("Oda yok!");
Â  Â  Â  Â  const rData = doc.data();
Â  Â  Â  Â  let players = rData.players;
Â  Â  Â  Â Â 
Â  Â  Â  Â  if(players.length >= 4 && !players.some(p => p.isBot)) return alert("Oda tamamen dolu!");
Â  Â  Â  Â Â 
Â  Â  Â  Â  let targetIndex = -1;
Â  Â  Â  Â  const sameNameBotIdx = players.findIndex(p => p.isBot && p.name.includes(myName));
Â  Â  Â  Â  if (sameNameBotIdx !== -1) {
Â  Â  Â  Â  Â  Â  targetIndex = sameNameBotIdx;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  const botIdx = players.findIndex(p => p.isBot);
Â  Â  Â  Â  Â  Â  if (botIdx !== -1) targetIndex = botIdx;
Â  Â  Â  Â  }

Â  Â  Â  Â  if (targetIndex !== -1) {
Â  Â  Â  Â  Â  Â  players[targetIndex] = {
Â  Â  Â  Â  Â  Â  Â  Â  ...players[targetIndex],
Â  Â  Â  Â  Â  Â  Â  Â  uid: myUid,
Â  Â  Â  Â  Â  Â  Â  Â  name: myName,
Â  Â  Â  Â  Â  Â  Â  Â  isBot: false,
Â  Â  Â  Â  Â  Â  Â  Â  isReady: rData.status === 'playing',Â 
Â  Â  Â  Â  Â  Â  Â  Â  lastSeen: Date.now()
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  roomRef.update({ players: players }).then(() => {
Â  Â  Â  Â  Â  Â  Â  Â  currentRoomId = roomId; isHost = false;Â 
Â  Â  Â  Â  Â  Â  Â  Â  db.collection('online_users').doc(myUid).update({status: 'waiting'});
Â  Â  Â  Â  Â  Â  Â  Â  enterWaitingRoom(rData.name);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  if(rData.status === 'playing') return alert("Oda dolu ve bot yok!");
Â  Â  Â  Â  Â  Â  roomRef.update({
Â  Â  Â  Â  Â  Â  Â  Â  players: firebase.firestore.FieldValue.arrayUnion({ uid: myUid, name: myName, isBot: false, score: 0, hand: [], isReady: false, saidSonTabak: false, challengeUsed: false, personality: 'Dengeli', lastSeen: Date.now() })
Â  Â  Â  Â  Â  Â  }).then(() => {
Â  Â  Â  Â  Â  Â  Â  Â  currentRoomId = roomId; isHost = false;Â 
Â  Â  Â  Â  Â  Â  Â  Â  db.collection('online_users').doc(myUid).update({status: 'waiting'});
Â  Â  Â  Â  Â  Â  Â  Â  enterWaitingRoom(rData.name);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  });
}

function enterWaitingRoom(roomName) {
Â  Â  document.getElementById('new-lobby-screen').style.display = 'none';
Â  Â  document.getElementById('waiting-room-overlay').style.display = 'flex';
Â  Â  document.getElementById('leave-room-btn').onclick = () => { document.getElementById('leave-modal').style.display = 'flex'; };

Â  Â  if(roomUnsubscribe) roomUnsubscribe();
Â  Â Â 
Â  Â  if(heartbeatInterval) clearInterval(heartbeatInterval);
Â  Â  heartbeatInterval = setInterval(sendHeartbeat, ANIM_CONFIG.HEARTBEAT_MS);

Â  Â  roomUnsubscribe = db.collection("rooms").doc(currentRoomId).onSnapshot((docSnap) => {
Â  Â  Â  Â  if(!docSnap.exists) {Â 
Â  Â  Â  Â  Â  Â  // Oda silinmiÅŸse lobiye dÃ¶n
Â  Â  Â  Â  Â  Â  resetToLobbyState();
Â  Â  Â  Â  Â  Â  return;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  const data = docSnap.data();
Â  Â  Â  Â  localPlayers = data.players;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // FIX: Host deÄŸiÅŸimi durumunda isHost gÃ¼ncellemesi
Â  Â  Â  Â  isHost = (localPlayers[0].uid === myUid);

Â  Â  Â  Â  document.getElementById(isHost ? 'wr-host-controls' : 'wr-guest-controls').style.display = 'block';
Â  Â  Â  Â  document.getElementById(!isHost ? 'wr-host-controls' : 'wr-guest-controls').style.display = 'none';
Â  Â  Â  Â  document.getElementById('wr-room-name').innerText = `Oda: ${data.name}`;
Â  Â  Â  Â  document.getElementById('wr-count').innerText = localPlayers.length;
Â  Â  Â  Â  const ul = document.getElementById('wr-player-list'); ul.innerHTML = "";
Â  Â  Â  Â  localPlayers.forEach(p => { ul.innerHTML += `<li class="player-item"><span>${p.isBot?'ğŸ¤– ':''}${p.name}</span> ${(p.uid===data.hostId)?'(Host)':''}</li>`; });
Â  Â  Â  Â Â 
Â  Â  Â  Â  if(data.status === 'playing') {
Â  Â  Â  Â  Â  Â  document.getElementById('waiting-room-overlay').style.display = 'none';
Â  Â  Â  Â  Â  Â  document.getElementById('main-game-wrapper').style.display = 'grid'; // Show Game Wrapper (or Flex on mobile)
Â  Â  Â  Â  Â  Â  db.collection('online_users').doc(myUid).update({status: 'playing'});
Â  Â  Â  Â  Â  Â  myPlayerIdx = localPlayers.findIndex(p => p.uid === myUid);
Â  Â  Â  Â  Â  Â  syncGameLoop(data);
Â  Â  Â  Â  }
Â  Â  });
}

function sendHeartbeat() {
Â  Â  if(isOfflineMode) return;
Â  Â  if(!currentRoomId || !myUid) return;
Â  Â  db.collection("rooms").doc(currentRoomId).get().then(doc => {
Â  Â  Â  Â  if(doc.exists) {
Â  Â  Â  Â  Â  Â  let ps = doc.data().players;
Â  Â  Â  Â  Â  Â  let me = ps.find(p => p.uid === myUid);
Â  Â  Â  Â  Â  Â  if(me) {
Â  Â  Â  Â  Â  Â  Â  Â  me.lastSeen = Date.now();
Â  Â  Â  Â  Â  Â  Â  Â  db.collection("rooms").doc(currentRoomId).update({ players: ps, lastActive: Date.now() });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  });
}

document.getElementById('start-game-btn').addEventListener('click', () => {
Â  Â  if(localPlayers.length < 2) return alert("En az 2 oyuncu!");
Â  Â  let finalPlayers = [...localPlayers];
Â  Â  const botNames = ["ğŸ¤– Rifu", "ğŸ¤– Utku", "ğŸ¤– KÃ¼bra", "ğŸ¤– Atlas"];
Â  Â  const personalities = ["Agresif", "Stratejik", "Panik Atak", "Rahat", "GÄ±cÄ±k"];
Â  Â  let botIdx = 0;
Â  Â  while(finalPlayers.length < 4) {
Â  Â  Â  Â  let pType = personalities[Math.floor(Math.random()*personalities.length)];
Â  Â  Â  Â  finalPlayers.push({ uid: 'bot_' + Date.now() + '_' + botIdx, name: botNames[botIdx % botNames.length], isBot: true, score: 0, hand: [], isReady: true, saidSonTabak: false, challengeUsed: false, personality: pType, lastSeen: Date.now() });
Â  Â  Â  Â  botIdx++;
Â  Â  }
Â  Â  finalPlayers = shuffleDeck(finalPlayers);
Â  Â  finalPlayers = finalPlayers.map(p => ({...p, isReady: false, saidSonTabak: false, challengeUsed: false }));
Â  Â Â 
Â  Â  const newDeck = createFullDeck();
Â  Â  const hands = [[], [], [], []];
Â  Â  for(let i=0; i<7; i++) { for(let p=0; p<4; p++) hands[p].push(newDeck.pop()); }
Â  Â  finalPlayers.forEach((p, i) => p.hand = hands[i]);
Â  Â  let first = newDeck.pop();
Â  Â  while(first.color === 'wild' || first.type === 'action') { newDeck.unshift(first); first = newDeck.pop(); }
Â  Â Â 
Â  Â  const initialState = {
Â  Â  Â  Â  deck: newDeck, discardPile: [first], currentPlayer: Math.floor(Math.random()*4), direction: 1, drawStack: 0, gameActive: true,
Â  Â  Â  Â  lastAction: { type: 'start', timestamp: Date.now() }, vulnerablePlayerIdx: -1, playerColors: shuffleDeck(['#c0392b', '#f1c40f', '#8e44ad', '#27ae60']),
Â  Â  Â  Â  lastChat: { sender: "Sistem", msg: "Oyun BaÅŸladÄ±!", ts: Date.now(), isSystem: true }, hasDrawn: false
Â  Â  };
Â  Â  db.collection("rooms").doc(currentRoomId).update({ status: 'playing', players: finalPlayers, gameState: initialState, lastActive: Date.now() });
});

/* --- GAME LOOP (Sync Logic) --- */
let isBotThinking = false;Â 
let lastBotActionTime = 0;Â 

function syncGameLoop(roomData) {
Â  Â  const gs = roomData.gameState;
Â  Â  if(!gs) return;
Â  Â Â 
Â  Â  gameDeck = gs.deck; gameDiscard = gs.discardPile; gamePlayers = roomData.players;
Â  Â  gameHands = gamePlayers.map(p => p.hand);
Â  Â  currentPlayer = gs.currentPlayer; direction = gs.direction; drawStack = gs.drawStack;
Â  Â  gameActive = gs.gameActive; vulnerablePlayerIdx = gs.vulnerablePlayerIdx; playerColors = gs.playerColors;
Â  Â  hasDrawn = gs.hasDrawn || false;

Â  Â  if(currentPlayer !== myPlayerIdx) localSaidSonTabak = false;

Â  Â  if(gs.lastChat && gs.lastChat.ts > lastChatTs) {
Â  Â  Â  Â  if(gs.lastChat.isSystem) addSystemLog(gs.lastChat.msg);
Â  Â  Â  Â  else {
Â  Â  Â  Â  Â  Â  let senderIdx = gamePlayers.findIndex(p => p.name === gs.lastChat.sender);
Â  Â  Â  Â  Â  Â  let color = senderIdx !== -1 ? (playerColors[senderIdx] || '#333') : '#333';
Â  Â  Â  Â  Â  Â  addChatLog(gs.lastChat.sender, gs.lastChat.msg, color);
Â  Â  Â  Â  Â  Â  if(senderIdx !== -1 && senderIdx !== myPlayerIdx) {
Â  Â  Â  Â  Â  Â  Â  Â  let relIdx = (senderIdx - myPlayerIdx + 4) % 4;Â 
Â  Â  Â  Â  Â  Â  Â  Â  let b = document.getElementById(`bot${relIdx}-chat`);
Â  Â  Â  Â  Â  Â  Â  Â  if(b) { b.innerText = gs.lastChat.msg; b.classList.add('visible'); setTimeout(()=>b.classList.remove('visible'),3000); }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  lastChatTs = gs.lastChat.ts;
Â  Â  }

Â  Â  if(lastGameState && lastGameState.lastAction.timestamp !== gs.lastAction.timestamp) {
Â  Â  Â  Â  actionQueue.push(gs.lastAction);
Â  Â  Â  Â  processActionQueue();
Â  Â  } else if (!isProcessingQueue) {
Â  Â  Â  Â  updateUI();Â 
Â  Â  }
Â  Â Â 
Â  Â  // BOT & AFK HANDLERS (Only for Host)
Â  Â  if(isHost && gameActive && !isBotThinking && !isDealing) {
Â  Â  Â  Â  if (!isOfflineMode) {
Â  Â  Â  Â  Â  Â  Â let currentPObj = gamePlayers[currentPlayer];
Â  Â  Â  Â  Â  Â  Â if(!currentPObj.isBot) {
Â  Â  Â  Â  Â  Â  Â  Â  Â let timeSinceAction = Date.now() - gs.lastAction.timestamp;
Â  Â  Â  Â  Â  Â  Â  Â  Â if(timeSinceAction > ANIM_CONFIG.AFK_TIMEOUT) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const updatedPlayers = gamePlayers.map(p => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (p.uid === currentPObj.uid) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â return { ...p, uid: 'afk_bot_' + Date.now(), name: 'ğŸ¤– ' + p.name, isBot: true, isReady: true, personality: 'Dengeli', lastSeen: Date.now() };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â return p;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â db.collection("rooms").doc(currentRoomId).update({Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â players: updatedPlayers,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â "gameState.lastChat": { sender: "Sistem", msg: `${currentPObj.name} AFK kaldÄ±ÄŸÄ± iÃ§in bot devraldÄ±.`, ts: Date.now(), isSystem: true }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Bot Logic Trigger
Â  Â  Â  Â  if(!isProcessingQueue && actionQueue.length === 0) {
Â  Â  Â  Â  Â  Â  const currentPObj = gamePlayers[currentPlayer];
Â  Â  Â  Â  Â  Â  if(currentPObj && currentPObj.isBot) {
Â  Â  Â  Â  Â  Â  Â  Â  isBotThinking = true;
Â  Â  Â  Â  Â  Â  Â  Â  lastBotActionTime = Date.now();
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hostBotTurn().then(() => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isBotThinking = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // FIX: Offline modda hamle bittikten sonra tekrar tetikleme
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(isOfflineMode && gameActive && isHost) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â syncGameLoop({ players: gamePlayers, gameState: lastGameState });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 50);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }).catch(e => { console.error("Bot Error", e); isBotThinking = false; });
Â  Â  Â  Â  Â  Â  Â  Â  }, ANIM_CONFIG.BOT_THINK);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // GAME END CHECK (Wait for Queue)
Â  Â  if (gs.winnerIdx !== undefined && gs.winnerIdx !== -1 && gameActive === false) {
Â  Â  Â  Â  if(actionQueue.length === 0 && !isProcessingQueue) { // Wait for animation
Â  Â  Â  Â  Â  Â  Â if(document.getElementById('end-modal').style.display !== 'flex') showEndGame(gs.winnerIdx, roomData.players);
Â  Â  Â  Â  Â  Â  Â updateReadyStatusUI();
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  if(!lastGameState && gs.lastAction.type === 'start') {
Â  Â  Â  Â  Â actionQueue.push(gs.lastAction);Â 
Â  Â  Â  Â  Â processActionQueue();
Â  Â  }
Â  Â Â 
Â  Â  lastGameState = gs;
}

/* --- ACTION HANDLING --- */
async function processActionQueue() {
Â  Â  if(isProcessingQueue || actionQueue.length === 0) {
Â  Â  Â  Â  // FIX: Kuyruk bittiÄŸinde ve offline moddaysak dÃ¶ngÃ¼yÃ¼ tekrar tetikle (Animasyon sonrasÄ± botun oynamasÄ± iÃ§in)
Â  Â  Â  Â  // EÄŸer oyun bittiyse (winnerIdx varsa) de son bir sync yap ki modal aÃ§Ä±lsÄ±n.
Â  Â  Â  Â  if(actionQueue.length === 0 && !isProcessingQueue && isHost && isOfflineMode) {
Â  Â  Â  Â  Â  Â  Â if (gameActive || (lastGameState && lastGameState.winnerIdx !== -1)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â syncGameLoop({ players: gamePlayers, gameState: lastGameState });
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  }
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  isProcessingQueue = true;
Â  Â  const action = actionQueue.shift();
Â  Â  await handleRemoteAction(action);Â 
Â  Â  updateUI();
Â  Â  isProcessingQueue = false;
Â  Â  processActionQueue();
}

async function handleRemoteAction(action) {
Â  Â  if(!action) return;
Â  Â Â 
Â  Â  if(action.type === 'sonTabak') {
Â  Â  Â  Â  const pName = gamePlayers[action.pIdx].name;
Â  Â  Â  Â  showSonTabakPopup(pName);
Â  Â  Â  Â  SoundFX.playUno();
Â  Â  }
Â  Â  else if(action.type === 'challenge') {
Â  Â  Â  Â  let victimName = action.victimIdx !== undefined ? gamePlayers[action.victimIdx].name : "Biri";
Â  Â  Â  Â  let msg = action.success ? "BAÅARILI! âœ…" : "BAÅARISIZ! âŒ";
Â  Â  Â  Â  let detail = action.success ? `${victimName} ceza yedi!` : `Ä°tiraz haksÄ±zdÄ±!`;
Â  Â  Â  Â  showChallengePopup(action.success, msg, detail);
Â  Â  Â  Â Â 
Â  Â  Â  Â  if(action.success) SoundFX.playFanfare(); else SoundFX.playBad();
Â  Â  Â  Â Â 
Â  Â  Â  Â  if(action.victimIdx !== undefined) {
Â  Â  Â  Â  Â  Â  await wait(500);Â 
Â  Â  Â  Â  Â  Â  let targetId = action.victimIdx === myPlayerIdx ? 'player-hand' : `bot${(action.victimIdx - myPlayerIdx + 4) % 4}-wrapper`;
Â  Â  Â  Â  Â  Â  animateFly(document.getElementById('draw-pile'), document.getElementById(targetId), null);
Â  Â  Â  Â  }
Â  Â  }
Â  Â  else if(action.type === 'newRound' || action.type === 'start') {
Â  Â  Â  Â  document.getElementById('end-modal').style.display = 'none';
Â  Â  Â  Â  amIReady = false;Â 
Â  Â  Â  Â  document.getElementById('end-continue-btn').innerText = "Devam Et â³";
Â  Â  Â  Â  document.getElementById('end-continue-btn').className = "game-btn btn-blue";
Â  Â  Â  Â  await animateInitialDeal();
Â  Â  }
Â  Â  else if(action.type === 'play') {
Â  Â  Â  Â  let pIdx = action.pIdx;
Â  Â  Â  Â  let sourceId = pIdx === myPlayerIdx ? 'player-hand' : pIdx === (myPlayerIdx+1)%4 ? 'bot1-wrapper' : pIdx === (myPlayerIdx+2)%4 ? 'bot2-wrapper' : 'bot3-wrapper';
Â  Â  Â  Â  let source = document.getElementById(sourceId);
Â  Â  Â  Â  if(pIdx === myPlayerIdx && source.children.length > 0) source = source.children[Math.min(source.children.length-1, 3)];
Â  Â  Â  Â Â 
Â  Â  Â  Â  await new Promise(r => animateFly(source, document.getElementById('discard-pile'), createCardHTML(action.card), r));
Â  Â  Â  Â Â 
Â  Â  Â  Â  document.getElementById('discard-pile').innerHTML = createCardHTML(action.card);
Â  Â  Â  Â  if(action.card.val === 'Block') { SoundFX.playBlock(); animateBlock(pIdx); }
Â  Â  Â  Â  else if(action.card.val === 'Reverse') { SoundFX.playReverse(); await animateReverse(); }Â 
Â  Â  Â  Â  else if(action.card.color === 'wild') SoundFX.playWild();
Â  Â  Â  Â  else SoundFX.playCardSnap();

Â  Â  Â  Â  if(action.card.val === 'Wild Table') await animateTableEffect();
Â  Â  Â  Â  if(action.card.val === 'Wild Mixer') await animateMixerEffect(direction);Â 
Â  Â  Â  Â  if(action.card.val === 'Wild Pot') animatePotEffect(pIdx, direction);
Â  Â  Â  Â  if(action.card.val === 'Wild Meze') animateMezeEffect(pIdx);
Â  Â  }Â 
Â  Â  else if(action.type === 'draw') {
Â  Â  Â  Â  SoundFX.playDraw();
Â  Â  Â  Â  let targetId = action.pIdx === myPlayerIdx ? 'player-hand' : `bot${(action.pIdx - myPlayerIdx + 4) % 4}-wrapper`;
Â  Â  Â  Â  // INCREMENTAL DRAW VISUALIZATION FIX
Â  Â  Â  Â  isDealing = true; // Lock UI updates temporarily
Â  Â  Â  Â  let currentHandClone = [...gameHands[myPlayerIdx]]; // Real full hand
Â  Â  Â  Â  // We know that 'action.count' cards were added to end.
Â  Â  Â  Â  // We will visualize them being added one by one.
Â  Â  Â  Â Â 
Â  Â  Â  Â  // This loop simulates delay
Â  Â  Â  Â  for(let k=0; k<action.count; k++) {Â 
Â  Â  Â  Â  Â  Â  Â let cardToVisualize = null;
Â  Â  Â  Â  Â  Â  Â // If it's me, I want to see the card face
Â  Â  Â  Â  Â  Â  Â if(action.pIdx === myPlayerIdx) {
Â  Â  Â  Â  Â  Â  Â  Â  Â // The card is at index: (length - count + k)
Â  Â  Â  Â  Â  Â  Â  Â  Â let idx = currentHandClone.length - action.count + k;
Â  Â  Â  Â  Â  Â  Â  Â  Â if(idx >= 0 && idx < currentHandClone.length) cardToVisualize = createCardHTML(currentHandClone[idx]);
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â await new Promise(resolve => {
Â  Â  Â  Â  Â  Â  Â  Â  Â animateFly(document.getElementById('draw-pile'), document.getElementById(targetId), cardToVisualize, () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // Add to DOM visually if it's me
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if(action.pIdx === myPlayerIdx && cardToVisualize) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â let div = document.createElement('div'); div.innerHTML = cardToVisualize;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â let el = div.firstElementChild;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('player-hand').appendChild(el);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â resolve();
Â  Â  Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â await wait(100); // Small gap between flights
Â  Â  Â  Â  }
Â  Â  Â  Â  isDealing = false;
Â  Â  Â  Â  updateUI(); // Final sync
Â  Â  }
Â  Â  await wait(200);
}

/* --- GAME LOGIC (Host/Player) --- */
let gameDeck = [], gameDiscard = [], gameHands = [], gamePlayers = [], gameActive = false, direction = 1, currentPlayer = 0, drawStack = 0, vulnerablePlayerIdx = -1, playerColors = [], pendingWild = null, hasDrawn = false, lastWinner = -1;

function canPlay(card) {
Â  Â  let top = gameDiscard[gameDiscard.length-1]; let topColor = top.chosenColor || top.color;
Â  Â  if(drawStack > 0) { if(card.val === '+2' || card.val === 'Wild Meze' || card.val === 'Wild Anti-Draw') return true; if(card.val === '+1') { return top.val === '+2' || top.val === 'Wild Meze' ? card.color === topColor : true; } return false; }
Â  Â  return card.color === 'wild' || card.color === topColor || card.val === top.val;
}

function playerDrawCard() {
Â  Â  if(currentPlayer !== myPlayerIdx) return;
Â  Â  if(drawStack === 0 && gameHands[myPlayerIdx].some(c => canPlay(c))) { showToast("Oynanacak kartÄ±n var!"); return; }
Â  Â  if(hasDrawn) { serverPassTurn(myPlayerIdx); return; }
Â  Â Â 
Â  Â  let count = drawStack > 0 ? drawStack : 1;
Â  Â  let isPenalty = drawStack > 0;
Â  Â Â 
Â  Â  serverDrawCard(myPlayerIdx, count, isPenalty);
Â  Â  if(isPenalty || count > 1) {Â 
Â  Â  Â  Â  setTimeout(() => serverPassTurn(myPlayerIdx), 1500 + (count*600)); // Wait for animations
Â  Â  }
}
function playerPlayCard(idx) {
Â  Â  if(currentPlayer !== myPlayerIdx) return;
Â  Â  let card = gameHands[myPlayerIdx][idx];
Â  Â  if(canPlay(card)) {
Â  Â  Â  Â  if(card.color === 'wild') {
Â  Â  Â  Â  Â  Â  if(card.val === 'Wild Anti-Draw') { let top = gameDiscard[gameDiscard.length-1]; card.chosenColor = top.chosenColor || top.color; if(card.chosenColor==='wild') card.chosenColor = 'red'; serverPlayCard(myPlayerIdx, idx, card, 1, localSaidSonTabak); }
Â  Â  Â  Â  Â  Â  else { pendingWild = { idx, card }; document.getElementById('color-modal').style.display = 'flex'; }
Â  Â  Â  Â  } else serverPlayCard(myPlayerIdx, idx, card, 1, localSaidSonTabak);
Â  Â  } else { SoundFX.playError(); showToast("Oynanamaz!"); }
}
function resolveColor(c) {Â 
Â  Â  document.getElementById('color-modal').style.display = 'none';Â 
Â  Â  if(pendingWild) {Â 
Â  Â  Â  Â  let card = pendingWild.card; card.chosenColor = c;Â 
Â  Â  Â  Â  if(card.val === 'Wild Mixer') {Â 
Â  Â  Â  Â  Â  Â  let pRightIdx = (myPlayerIdx + 1) % 4; // Saat yÃ¶nÃ¼ndeki
Â  Â  Â  Â  Â  Â  let pLeftIdx = (myPlayerIdx + 3) % 4; // Ters yÃ¶nÃ¼ndeki
Â  Â  Â  Â  Â  Â  let pRightName = gamePlayers[pRightIdx].name;
Â  Â  Â  Â  Â  Â  let pLeftName = gamePlayers[pLeftIdx].name;
Â  Â  Â  Â  Â  Â  let pRightCount = gameHands[pRightIdx].length;
Â  Â  Â  Â  Â  Â  let pLeftCount = gameHands[pLeftIdx].length;

Â  Â  Â  Â  Â  Â  document.getElementById('mixer-info').innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <b>â¡ï¸ Saat:</b> ${pLeftName}'in elini (${pLeftCount} Kart) alacaksÄ±n.<br>
Â  Â  Â  Â  Â  Â  Â  Â  <b>â¬…ï¸ Ters:</b> ${pRightName}'in elini (${pRightCount} Kart) alacaksÄ±n.
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  document.getElementById('dir-modal').style.display = 'flex';Â 
Â  Â  Â  Â  } else {Â 
Â  Â  Â  Â  Â  Â  serverPlayCard(myPlayerIdx, pendingWild.idx, card, 1, localSaidSonTabak);Â 
Â  Â  Â  Â  Â  Â  pendingWild = null;Â 
Â  Â  Â  Â  }Â 
Â  Â  }Â 
}
function resolveDirection(d) { document.getElementById('dir-modal').style.display = 'none'; if(pendingWild) { serverPlayCard(myPlayerIdx, pendingWild.idx, pendingWild.card, d, localSaidSonTabak); pendingWild = null; } }

function playerSaySonTabak() {Â 
Â  Â  if(currentPlayer !== myPlayerIdx || gameHands[myPlayerIdx].length > 2) return;Â 
Â  Â Â 
Â  Â  localSaidSonTabak = true;Â 
Â  Â  let ps = [...gamePlayers]; ps[myPlayerIdx].saidSonTabak = true;Â 
Â  Â Â 
Â  Â  const updateData = {Â 
Â  Â  Â  Â  players: ps,Â 
Â  Â  Â  Â  "gameState.vulnerablePlayerIdx": -1,Â 
Â  Â  Â  Â  "gameState.lastAction": { type: 'sonTabak', pIdx: myPlayerIdx, timestamp: Date.now() },
Â  Â  Â  Â  "gameState.lastChat": { sender: "Sistem", msg: `<b style="color:${playerColors[myPlayerIdx]}">${myName}</b> SON TABAK dedi!`, ts: Date.now(), isSystem: true }Â 
Â  Â  };

Â  Â  if(isOfflineMode) {
Â  Â  Â  Â  updateOfflineGameState(updateData);
Â  Â  } else {
Â  Â  Â  Â  db.collection("rooms").doc(currentRoomId).update(updateData);Â 
Â  Â  }
}

function challengePreviousPlayer() {
Â  Â  if(currentPlayer !== myPlayerIdx || gamePlayers[myPlayerIdx].challengeUsed) return;
Â  Â  if(vulnerablePlayerIdx !== -1) {Â 
Â  Â  Â  Â  serverPunishVulnerable(vulnerablePlayerIdx);Â 
Â  Â  Â  Â  let msg = { sender: "Sistem", msg: `<b style="color:${playerColors[myPlayerIdx]}">${myName}</b> Ä°TÄ°RAZ ETTÄ° ve kazandÄ±!`, ts: Date.now(), isSystem: true };
Â  Â  Â  Â  if(isOfflineMode) updateOfflineGameState({"gameState.lastChat": msg}); else db.collection("rooms").doc(currentRoomId).update({ "gameState.lastChat": msg });Â 
Â  Â  }
Â  Â  else {Â 
Â  Â  Â  Â  serverPunishChallenger(myPlayerIdx);Â 
Â  Â  Â  Â  let msg = { sender: "Sistem", msg: `<b style="color:${playerColors[myPlayerIdx]}">${myName}</b> YANLIÅ Ä°TÄ°RAZ ETTÄ°!`, ts: Date.now(), isSystem: true };
Â  Â  Â  Â  if(isOfflineMode) updateOfflineGameState({"gameState.lastChat": msg}); else db.collection("rooms").doc(currentRoomId).update({ "gameState.lastChat": msg });Â 
Â  Â  }
}
function playerSendMessage() {Â 
Â  Â  let input = document.getElementById('player-input'); let msg = input.value.trim();Â 
Â  Â  if(msg) {Â 
Â  Â  Â  Â  let chatObj = { "gameState.lastChat": { sender: myName, msg: msg, ts: Date.now(), isSystem: false }, "lastActive": Date.now() };
Â  Â  Â  Â  if(isOfflineMode) updateOfflineGameState(chatObj); else db.collection("rooms").doc(currentRoomId).update(chatObj);Â 
Â  Â  Â  Â  input.value = '';Â 
Â  Â  }Â 
}

/* --- SERVER ACTIONS (Unified for Online/Offline) --- */
function updateOfflineGameState(updates) {
Â  Â  if(!lastGameState) return;
Â  Â Â 
Â  Â  // Deep Merge simple Simulation
Â  Â  let nextState = JSON.parse(JSON.stringify(lastGameState));
Â  Â  let nextPlayers = JSON.parse(JSON.stringify(gamePlayers));

Â  Â  if(updates.players) nextPlayers = updates.players;
Â  Â Â 
Â  Â  for(let key in updates) {
Â  Â  Â  Â  if(key.startsWith("gameState.")) {
Â  Â  Â  Â  Â  Â  let field = key.split(".")[1];
Â  Â  Â  Â  Â  Â  nextState[field] = updates[key];
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  syncGameLoop({ players: nextPlayers, gameState: nextState });
}

function recycleDeck(discardPile) {
Â  Â  let cleanDeck = discardPile.map(c => {
Â  Â  Â  Â  let copy = {...c};
Â  Â  Â  Â  delete copy.chosenColor;Â 
Â  Â  Â  Â  return copy;
Â  Â  });
Â  Â  return shuffleDeck(cleanDeck);
}

async function serverDrawCard(pIdx, count, isPenalty = false) {
Â  Â  let newDeck = [...gameDeck], newDiscard = [...gameDiscard];
Â  Â  let newHands = gameHands.map(h => [...h]);Â 
Â  Â Â 
Â  Â  if(newDeck.length < count && newDiscard.length > 1) {Â 
Â  Â  Â  Â  let top = newDiscard.pop();Â 
Â  Â  Â  Â  newDeck = recycleDeck(newDiscard);Â 
Â  Â  Â  Â  newDiscard = [top];Â 
Â  Â  }
Â  Â  for(let i=0; i<count; i++) if(newDeck.length > 0) newHands[pIdx].push(newDeck.pop());
Â  Â  let pUpdates = [...gamePlayers]; pUpdates[pIdx].hand = newHands[pIdx]; pUpdates[pIdx].saidSonTabak = false;
Â  Â Â 
Â  Â  let updates = { "players": pUpdates, "gameState.deck": newDeck, "gameState.discardPile": newDiscard, "gameState.drawStack": 0, "gameState.hasDrawn": true, "gameState.lastAction": { type: 'draw', pIdx, count, timestamp: Date.now() }, "lastActive": Date.now(), "gameState.lastChat": { sender: "Sistem", msg: `<b style="color:${playerColors[pIdx]}">${gamePlayers[pIdx].name}</b> ${count} kart Ã§ekti.`, ts: Date.now(), isSystem: true } };
Â  Â  if(isPenalty) {
Â  Â  Â  Â  updates["gameState.hasDrawn"] = false;Â 
Â  Â  Â  Â  updates["gameState.lastChat"].msg += " (Ceza)";
Â  Â  }
Â  Â Â 
Â  Â  if(isOfflineMode) updateOfflineGameState(updates); else await db.collection("rooms").doc(currentRoomId).update(updates);
}
async function serverPassTurn(pIdx) {Â 
Â  Â  let u = { "gameState.currentPlayer": (currentPlayer + direction + 4) % 4, "gameState.hasDrawn": false, "gameState.vulnerablePlayerIdx": -1, "lastActive": Date.now(), "gameState.lastChat": { sender: "Sistem", msg: `<b style="color:${playerColors[pIdx]}">${gamePlayers[pIdx].name}</b> Pas geÃ§ti.`, ts: Date.now(), isSystem: true } };
Â  Â  if(isOfflineMode) updateOfflineGameState(u); else await db.collection("rooms").doc(currentRoomId).update(u);
}

async function serverPlayCard(pIdx, cIdx, cardWithColor, mixerDir = 1, declaredSonTabak = false) {
Â  Â  let newHands = gameHands.map(h => [...h]);Â 
Â  Â  let newDiscard = [...gameDiscard];
Â  Â  if(!newHands[pIdx] || !newHands[pIdx][cIdx]) return;

Â  Â  let card = newHands[pIdx][cIdx]; if(cardWithColor) card = cardWithColor;
Â  Â Â 
Â  Â  newHands[pIdx].splice(cIdx, 1);Â 
Â  Â  newDiscard.push(card);
Â  Â Â 
Â  Â  let newDir = direction, newDrawStack = drawStack, nextP = currentPlayer, newWinner = -1;
Â  Â  let playerUpdates = [...gamePlayers]; playerUpdates[pIdx].saidSonTabak = false;
Â  Â  if(newHands[pIdx].length === 0) newWinner = pIdx;
Â  Â Â 
Â  Â  if(card.val === 'Wild Mixer') {Â 
Â  Â  Â  Â  newDir = mixerDir || 1;Â 
Â  Â  } else if (card.val === 'Reverse') {Â 
Â  Â  Â  Â  newDir *= -1;Â 
Â  Â  }

Â  Â  if(newWinner === -1) {Â 
Â  Â  Â  Â  if(card.val === 'Block') nextP = (currentPlayer + (newDir * 2) + 4) % 4;Â 
Â  Â  Â  Â  else nextP = (currentPlayer + newDir + 4) % 4;Â 
Â  Â  }

Â  Â  if(card.val === '+1') newDrawStack += 1; if(card.val === '+2') newDrawStack += 2; if(card.val === 'Wild Meze') newDrawStack += 1; if(card.val === 'Wild Anti-Draw') newDrawStack = 0;
Â  Â Â 
Â  Â  if(card.val === 'Wild Table') {Â 
Â  Â  Â  Â  let counts = newHands.map(h => h.length);Â 
Â  Â  Â  Â  let allCards = [];Â 
Â  Â  Â  Â  newHands.forEach(h => { allCards.push(...h); h.length = 0; });Â 
Â  Â  Â  Â  allCards = shuffleDeck(allCards);Â 
Â  Â  Â  Â  for(let i=0; i<4; i++) {
Â  Â  Â  Â  Â  Â  for(let j=0; j<counts[i]; j++) {
Â  Â  Â  Â  Â  Â  Â  Â  if(allCards.length > 0) newHands[i].push(allCards.pop());
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  if(card.val === 'Wild Mixer') {Â 
Â  Â  Â  Â  if(newDir === 1) { let temp = newHands[3]; newHands[3] = newHands[2]; newHands[2] = newHands[1]; newHands[1] = newHands[0]; newHands[0] = temp; }Â 
Â  Â  Â  Â  else { let temp = newHands[0]; newHands[0] = newHands[1]; newHands[1] = newHands[2]; newHands[2] = newHands[3]; newHands[3] = temp; }Â 
Â  Â  }
Â  Â  if(card.val === 'Wild Pot') {Â 
Â  Â  Â  Â  for(let k=0; k<4; k++) {
Â  Â  Â  Â  Â  Â  let targetP = (pIdx + (k * newDir) + 4) % 4;Â 
Â  Â  Â  Â  Â  Â  if(gameDeck.length > 0) newHands[targetP].push(gameDeck.pop());
Â  Â  Â  Â  }
Â  Â  }
Â  Â  if(card.val === 'Wild Meze') { let prevP = (pIdx - newDir + 4) % 4; if(gameDeck.length > 0) newHands[prevP].push(gameDeck.pop()); }
Â  Â  playerUpdates = playerUpdates.map((p, i) => ({...p, hand: newHands[i]}));
Â  Â Â 
Â  Â  let isSafe = gamePlayers[pIdx].saidSonTabak || declaredSonTabak;
Â  Â  let newVulnerable = (newHands[pIdx].length === 1 && !isSafe) ? pIdx : -1;Â 
Â  Â  if(nextP === newVulnerable) newVulnerable = -1;
Â  Â Â 
Â  Â  let cardName = card.type === 'num' ? `${card.val} ${VEGETABLES[card.color]}` : (card.val==='Wild' ? `GÃ¼veÃ§ (${VEGETABLES[card.chosenColor]})` : (CARD_NAMES[card.val] || card.val));
Â  Â  if(card.val === 'Wild Anti-Draw') cardName += " (Joker)";

Â  Â  let updates = { "players": playerUpdates, "gameState.discardPile": newDiscard, "gameState.currentPlayer": nextP, "gameState.direction": newDir, "gameState.drawStack": newDrawStack, "gameState.vulnerablePlayerIdx": newVulnerable, "gameState.hasDrawn": false, "gameState.lastAction": { type: 'play', pIdx, card, timestamp: Date.now() }, "lastActive": Date.now(), "gameState.lastChat": { sender: "Sistem", msg: `<b style="color:${playerColors[pIdx]}">${gamePlayers[pIdx].name}</b> ${cardName} attÄ±.`, ts: Date.now(), isSystem: true } };
Â  Â  if(card.val === 'Wild Pot' || card.val === 'Wild Meze' || card.val === 'Wild Table') updates["gameState.deck"] = gameDeck;
Â  Â  if(newWinner !== -1) {Â 
Â  Â  Â  Â  updates["gameState.gameActive"] = false;Â 
Â  Â  Â  Â  updates["gameState.winnerIdx"] = newWinner;Â 
Â  Â  Â  Â  let roundScores = newHands.map(h => h.reduce((sum, c) => sum + (c.type==='num'?parseInt(c.val):20), 0));Â 
Â  Â  Â  Â  updates["players"] = playerUpdates.map((p, i) => ({ ...p, score: p.score + roundScores[i], lastRoundScore: roundScores[i] }));Â 
Â  Â  }
Â  Â Â 
Â  Â  if(isOfflineMode) updateOfflineGameState(updates); else await db.collection("rooms").doc(currentRoomId).update(updates);
}
async function serverPunishVulnerable(victimIdx) {Â 
Â  Â  let newDeck = [...gameDeck], newHands = gameHands.map(h=>[...h]), c = newDeck.pop(); if(c) newHands[victimIdx].push(c); let pUpdates = [...gamePlayers]; pUpdates[victimIdx].hand = newHands[victimIdx];Â 
Â  Â  let u = { "players": pUpdates, "gameState.deck": newDeck, "gameState.vulnerablePlayerIdx": -1, "gameState.lastAction": { type: 'challenge', success: true, victimIdx: victimIdx, timestamp: Date.now() } };
Â  Â  if(isOfflineMode) updateOfflineGameState(u); else await db.collection("rooms").doc(currentRoomId).update(u);
}
async function serverPunishChallenger(challengerIdx) {Â 
Â  Â  let newDeck = [...gameDeck], newHands = gameHands.map(h=>[...h]), c = newDeck.pop(); if(c) newHands[challengerIdx].push(c); let pUpdates = [...gamePlayers]; pUpdates[challengerIdx].hand = newHands[challengerIdx]; pUpdates[challengerIdx].challengeUsed = true; let nextP = (currentPlayer + direction + 4) % 4;Â 
Â  Â  let u = { "players": pUpdates, "gameState.deck": newDeck, "gameState.currentPlayer": nextP, "gameState.hasDrawn": false, "gameState.lastAction": { type: 'challenge', success: false, victimIdx: challengerIdx, timestamp: Date.now() } };
Â  Â  if(isOfflineMode) updateOfflineGameState(u); else await db.collection("rooms").doc(currentRoomId).update(u);
}

async function nextRound() {
Â  Â  if(!isHost) return;
Â  Â  document.getElementById('end-modal').style.display = 'none';
Â  Â  const newDeck = createFullDeck();
Â  Â  const hands = [[], [], [], []];
Â  Â  for(let i=0; i<7; i++) { for(let p=0; p<4; p++) hands[p].push(newDeck.pop()); }
Â  Â  const updatedPlayers = gamePlayers.map((p, i) => ({ ...p, hand: hands[i], isReady: false, saidSonTabak: false, challengeUsed: false }));
Â  Â  let first = newDeck.pop(); while(first.color === 'wild' || first.type === 'action') { newDeck.unshift(first); first = newDeck.pop(); }
Â  Â  const nextState = { deck: newDeck, discardPile: [first], currentPlayer: lastWinner, direction: 1, drawStack: 0, gameActive: true, lastAction: { type: 'newRound', timestamp: Date.now() }, vulnerablePlayerIdx: -1, playerColors: playerColors, lastChat: { sender: "Sistem", msg: "Yeni El BaÅŸladÄ±!", ts: Date.now(), isSystem: true }, hasDrawn: false };
Â  Â Â 
Â  Â  if(isOfflineMode) {
Â  Â  Â  Â  syncGameLoop({ players: updatedPlayers, gameState: nextState });
Â  Â  } else {
Â  Â  Â  Â  await db.collection("rooms").doc(currentRoomId).update({ players: updatedPlayers, gameState: nextState, lastActive: Date.now() });
Â  Â  }
}

async function hostBotTurn() {
Â  Â  try {
Â  Â  Â  Â  if(!isHost) return;
Â  Â  Â  Â  const currentPObj = gamePlayers[currentPlayer];
Â  Â  Â  Â  if(!currentPObj || !currentPObj.isBot) return;Â 

Â  Â  Â  Â  const triggerChat = async (cat) => {
Â  Â  Â  Â  Â  Â  let pType = currentPObj.personality || 'Dengeli';
Â  Â  Â  Â  Â  Â  let pool = CHAT_POOL[pType] || CHAT_POOL['Dengeli'];
Â  Â  Â  Â  Â  Â  let msgs = pool[cat] || pool['draw_many'];
Â  Â  Â  Â  Â  Â  let msg = msgs[Math.floor(Math.random()*msgs.length)];
Â  Â  Â  Â  Â  Â  let u = { "gameState.lastChat": { sender: currentPObj.name, msg: msg, ts: Date.now(), isSystem: false } };
Â  Â  Â  Â  Â  Â  if(isOfflineMode) updateOfflineGameState(u); else db.collection("rooms").doc(currentRoomId).update(u).catch(e => console.log("Chat error", e));
Â  Â  Â  Â  };

Â  Â  Â  Â  if(vulnerablePlayerIdx !== -1 && vulnerablePlayerIdx !== currentPlayer) {
Â  Â  Â  Â  Â  Â  if(Math.random() < 0.95) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  await serverPunishVulnerable(vulnerablePlayerIdx);
Â  Â  Â  Â  Â  Â  Â  Â  let u = { "gameState.lastChat": { sender: "Sistem", msg: `<b style="color:${playerColors[currentPlayer]}">${currentPObj.name}</b> uyanÄ±klÄ±k yaptÄ± ve itiraz etti!`, ts: Date.now(), isSystem: true } };
Â  Â  Â  Â  Â  Â  Â  Â  if(isOfflineMode) updateOfflineGameState(u); else await db.collection("rooms").doc(currentRoomId).update(u);
Â  Â  Â  Â  Â  Â  Â  Â  await wait(1500);Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  const hand = gameHands[currentPlayer];
Â  Â  Â  Â  let playableIdx = -1;
Â  Â  Â  Â  let willSaySonTabak = false;
Â  Â  Â  Â Â 
Â  Â  Â  Â  if(drawStack > 0) {
Â  Â  Â  Â  Â  Â  playableIdx = hand.findIndex(c => c.val === '+2' || (c.val === '+1' && gameDiscard[gameDiscard.length-1].val==='+1') || c.val === 'Wild Meze' || c.val === 'Wild Anti-Draw');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  playableIdx = hand.findIndex(c => canPlay(c));
Â  Â  Â  Â  }

Â  Â  Â  Â  if(playableIdx !== -1 && hand.length === 2) {
Â  Â  Â  Â  Â  Â  Â if(Math.random() > 0.1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â await serverBotSaySonTabak(currentPlayer);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â willSaySonTabak = true;
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  }

Â  Â  Â  Â  if (drawStack > 0 && playableIdx === -1) {
Â  Â  Â  Â  Â  Â  triggerChat("draw_many");
Â  Â  Â  Â  Â  Â  await serverDrawCard(currentPlayer, drawStack, true);Â 
Â  Â  Â  Â  Â  Â  setTimeout(() => serverPassTurn(currentPlayer), 1500 + (drawStack*600));Â 
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  if(playableIdx !== -1) {
Â  Â  Â  Â  Â  Â  let card = hand[playableIdx];
Â  Â  Â  Â  Â  Â  if(card.color === 'wild') {
Â  Â  Â  Â  Â  Â  Â  Â  if (card.val === 'Wild Anti-Draw') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // FIX: Inherit current color for Toilet Paper
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let top = gameDiscard[gameDiscard.length - 1];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let currentActiveColor = top.chosenColor || top.color;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (currentActiveColor === 'wild') currentActiveColor = ['red','green','yellow','purple'][Math.floor(Math.random()*4)];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  card.chosenColor = currentActiveColor;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Standard Wilds: Random
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  triggerChat("wild");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  card.chosenColor = ['red','green','yellow','purple'][Math.floor(Math.random()*4)];
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if(card.val === '+2') triggerChat("plus2");
Â  Â  Â  Â  Â  Â  if(card.val === 'Block') triggerChat("block");
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Pass true if bot declared son tabak
Â  Â  Â  Â  Â  Â  if(card.val === 'Wild Mixer') await serverPlayCard(currentPlayer, playableIdx, card, 1, willSaySonTabak);Â 
Â  Â  Â  Â  Â  Â  else await serverPlayCard(currentPlayer, playableIdx, card, 1, willSaySonTabak);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  if(!hasDrawn) await serverDrawCard(currentPlayer, 1);
Â  Â  Â  Â  Â  Â  else await serverPassTurn(currentPlayer);
Â  Â  Â  Â  }
Â  Â  } catch(e) {
Â  Â  Â  Â  console.error("Bot Logic Error:", e);
Â  Â  Â  Â  throw e;
Â  Â  }
}

async function serverBotSaySonTabak(pIdx) {
Â  Â  let pUpdates = [...gamePlayers]; pUpdates[pIdx].saidSonTabak = true;
Â  Â  let pColor = playerColors[pIdx];
Â  Â  let u = { players: pUpdates, "gameState.vulnerablePlayerIdx": -1, "gameState.lastAction": { type: 'sonTabak', pIdx: pIdx, timestamp: Date.now() }, "gameState.lastChat": { sender: "Sistem", msg: `<b style="color:${pColor}">${gamePlayers[pIdx].name}</b> SON TABAK dedi!`, ts: Date.now(), isSystem: true } };
Â  Â  if(isOfflineMode) updateOfflineGameState(u); else await db.collection("rooms").doc(currentRoomId).update(u);
}

/* --- YARDIMCI GÃ–RSELLER & ANÄ°MASYONLAR --- */
function updateUI() {
Â  Â  if(myPlayerIdx === -1) return;
Â  Â  let aL = document.getElementById('arrow-left'), aR = document.getElementById('arrow-right'), aT1 = document.getElementById('arrow-top-1'), aT2 = document.getElementById('arrow-top-2');
Â  Â  aL.className = 'arrow-icon'; aR.className = 'arrow-icon'; aT1.className = 'arrow-top-static'; aT2.className = 'arrow-top-static';

Â  Â  if(direction === 1) { aL.innerText = 'â¬†ï¸'; aR.innerText = 'â¬‡ï¸'; aT1.innerText = 'â¡ï¸'; aT2.innerText = 'â¡ï¸'; } else { aL.innerText = 'â¬‡ï¸'; aR.innerText = 'â¬†ï¸'; aT1.innerText = 'â¬…ï¸'; aT2.innerText = 'â¬…ï¸'; }
Â  Â  if(gameActive) {
Â  Â  Â  Â  let topCard = gameDiscard[gameDiscard.length-1]; let activeColor = topCard ? (topCard.chosenColor || topCard.color) : null; if(activeColor === 'wild') activeColor = 'neutral';
Â  Â  Â  Â  let glowClass = activeColor ? `glow-${activeColor}` : '';
Â  Â  Â  Â  let relCurrent = (currentPlayer - myPlayerIdx + 4) % 4, relNext = ((currentPlayer+direction+4)%4 - myPlayerIdx + 4) % 4;
Â  Â  Â  Â  let tArr = null;
Â  Â  Â  Â  if((relCurrent===0 && relNext===1) || (relCurrent===1 && relNext===0)) tArr = aL;
Â  Â  Â  Â  if((relCurrent===1 && relNext===2) || (relCurrent===2 && relNext===1)) tArr = aT1;
Â  Â  Â  Â  if((relCurrent===2 && relNext===3) || (relCurrent===3 && relNext===2)) tArr = aT2;
Â  Â  Â  Â  if((relCurrent===3 && relNext===0) || (relCurrent===0 && relNext===3)) tArr = aR;
Â  Â  Â  Â  if(tArr && glowClass) tArr.classList.add('active', glowClass);
Â  Â  }

Â  Â  if(gameDeck) document.getElementById('deck-count').innerText = gameDeck.length;
Â  Â  let pBadge = document.getElementById('penalty-badge');
Â  Â Â 
Â  Â  // FIX: Badge Color Logic
Â  Â  if(drawStack > 0) {Â 
Â  Â  Â  Â  pBadge.innerText = "+" + drawStack;Â 
Â  Â  Â  Â  pBadge.style.display = 'flex';Â 
Â  Â  Â  Â  pBadge.className = `p-${Math.min(drawStack,6)}`; // En fazla p-6
Â  Â  } else {
Â  Â  Â  Â  pBadge.style.display = 'none';
Â  Â  }

Â  Â  let sortedP = [...gamePlayers].sort((a,b)=>a.score - b.score);
Â  Â  let html = "";
Â  Â  sortedP.forEach(p => {
Â  Â  Â  Â  Â let color = playerColors[gamePlayers.findIndex(x => x.uid===p.uid)] || '#333';
Â  Â  Â  Â  Â let isMe = p.uid === myUid;
Â  Â  Â  Â  Â html += `<tr class="${isMe?'me-row':''}"><td style="color:${color}; font-weight:${isMe?'900':'normal'};">${p.name}</td><td style="text-align:right;">${p.score}</td></tr>`;
Â  Â  });
Â  Â  document.getElementById('score-table').querySelector('tbody').innerHTML = html;

Â  Â  let dp = document.getElementById('discard-pile');
Â  Â  if(gameDiscard.length > 0) {
Â  Â  Â  Â  let c = gameDiscard[gameDiscard.length-1];
Â  Â  Â  Â  dp.innerHTML = createCardHTML(c);
Â  Â  Â  Â  let activeColor = c.chosenColor || c.color;
Â  Â  Â  Â  let cont = document.querySelector('.game-container');
Â  Â  Â  Â  cont.classList.remove('ambient-red', 'ambient-green', 'ambient-yellow', 'ambient-purple');
Â  Â  Â  Â  if(activeColor !== 'wild') cont.classList.add(`ambient-${activeColor}`);
Â  Â  }

Â  Â  if (!isDealing) {
Â  Â  Â  Â  let ph = document.getElementById('player-hand'); ph.innerHTML = '';
Â  Â  Â  Â  if(currentPlayer === myPlayerIdx) ph.classList.add('current-player-area'); else ph.classList.remove('current-player-area');
Â  Â  Â  Â  gameHands[myPlayerIdx].forEach((c, idx) => {
Â  Â  Â  Â  Â  Â  let div = document.createElement('div'); div.innerHTML = createCardHTML(c); let el = div.firstElementChild;
Â  Â  Â  Â  Â  Â  if(currentPlayer === myPlayerIdx && canPlay(c)) { el.classList.add('playable'); el.onclick = () => playerPlayCard(idx); } else el.style.opacity = 0.6;
Â  Â  Â  Â  Â  Â  ph.appendChild(el);
Â  Â  Â  Â  });
Â  Â  }

Â  Â  const visualIndices = [ (myPlayerIdx + 1) % 4, (myPlayerIdx + 2) % 4, (myPlayerIdx + 3) % 4 ];
Â  Â  for(let i=0; i<3; i++) {
Â  Â  Â  Â  let realIdx = visualIndices[i]; let p = gamePlayers[realIdx]; let elId = `bot${i+1}`;
Â  Â  Â  Â  if(p) {
Â  Â  Â  Â  Â  Â  let pColor = playerColors[realIdx] || '#333';
Â  Â  Â  Â  Â  Â  document.getElementById(`${elId}-name`).innerHTML = `<span style="color:${pColor}">${p.name}</span> (${p.hand.length})`;
Â  Â  Â  Â  Â  Â  let stack = document.getElementById(`${elId}-stack`); stack.innerHTML = "";
Â  Â  Â  Â  Â  Â  let visibleCount = Math.min(p.hand.length, 6);
Â  Â  Â  Â  Â  Â  let totalW = 60 + (visibleCount > 0 ? (visibleCount-1)*8 : 0);
Â  Â  Â  Â  Â  Â  stack.style.width = totalW + 'px';
Â  Â  Â  Â  Â  Â  for(let j=0; j<visibleCount; j++) {
Â  Â  Â  Â  Â  Â  Â  Â  let mc = document.createElement('div'); mc.className = 'mini-card-back'; mc.style.top = (j*4)+'px'; mc.style.left = (j*8)+'px'; stack.appendChild(mc);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if(currentPlayer === realIdx) document.getElementById(`${elId}-wrapper`).classList.add('current-player'); else document.getElementById(`${elId}-wrapper`).classList.remove('current-player');
Â  Â  Â  Â  }
Â  Â  }

Â  Â  let stBtn = document.getElementById('son-tabak-btn');
Â  Â  stBtn.disabled = !(currentPlayer === myPlayerIdx && gameHands[myPlayerIdx].length <= 2 && !gamePlayers[myPlayerIdx].saidSonTabak);
Â  Â  let chBtn = document.getElementById('challenge-btn');
Â  Â  chBtn.disabled = !(currentPlayer === myPlayerIdx && !gamePlayers[myPlayerIdx].challengeUsed);
}

function animateFly(from, to, html, callback) {
Â  Â  if(!from || !to) { if(callback) callback(); return; }
Â  Â  let f = from.getBoundingClientRect(); let t = to.getBoundingClientRect();
Â  Â  let el = document.createElement('div');
Â  Â  if(html) { let w = document.createElement('div'); w.innerHTML = html; el = w.firstElementChild; el.classList.add('flying-card'); } else { el.className = 'card card-back-style flying-card'; }
Â  Â Â 
Â  Â  // START CENTERED
Â  Â  let startX = f.left + f.width/2 - 52;Â 
Â  Â  let startY = f.top + f.height/2 - 77;
Â  Â Â 
Â  Â  // END CENTERED
Â  Â  let endX = t.left + t.width/2 - 52;Â 
Â  Â  let endY = t.top + t.height/2 - 77;
Â  Â Â 
Â  Â  // SOFRA FIX: If from='play-area' (table center)
Â  Â  if(from.id === 'play-area') {
Â  Â  Â  Â  let pa = document.getElementById('play-area').getBoundingClientRect();
Â  Â  Â  Â  startX = pa.left + pa.width/2 - 52;
Â  Â  Â  Â  startY = pa.top + pa.height/2 - 77;
Â  Â  }
Â  Â Â 
Â  Â  el.style.left = startX + 'px';Â 
Â  Â  el.style.top = startY + 'px';Â 
Â  Â  document.body.appendChild(el);
Â  Â Â 
Â  Â  void el.offsetWidth;Â 
Â  Â Â 
Â  Â  el.style.left = endX + 'px';Â 
Â  Â  el.style.top = endY + 'px';Â 
Â  Â Â 
Â  Â  setTimeout(() => { el.remove(); if(callback) callback(); }, ANIM_CONFIG.FLY_BUFFER);
}
function animateReverse() {Â 
Â  Â  return new Promise(resolve => {
Â  Â  Â  Â  document.querySelectorAll('.arrow-icon').forEach(el => { el.classList.add('arrow-spin'); });
Â  Â  Â  Â  document.querySelectorAll('.arrow-top-static').forEach(el => { el.classList.add('arrow-spin'); });
Â  Â  Â  Â  setTimeout(() => {Â 
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.arrow-icon').forEach(el => { el.classList.remove('arrow-spin'); });Â 
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.arrow-top-static').forEach(el => { el.classList.remove('arrow-spin'); });Â 
Â  Â  Â  Â  Â  Â  resolve();Â 
Â  Â  Â  Â  }, 1200);
Â  Â  });
}
function animateBlock(pIdx) {
Â  Â  let victimIdx = (pIdx + direction + 4) % 4;
Â  Â  let targetId = victimIdx === myPlayerIdx ? 'player-hand' : `bot${(victimIdx - myPlayerIdx + 4) % 4}-wrapper`;
Â  Â  let el = document.getElementById(targetId);
Â  Â  if(el) {
Â  Â  Â  Â  let b = document.createElement('div'); b.innerText = 'ğŸ”ª'; b.className = 'blocked-anim';
Â  Â  Â  Â  let r = el.getBoundingClientRect(); b.style.left = r.left+(r.width/2)+'px'; b.style.top = r.top+(r.height/2)+'px';
Â  Â  Â  Â  document.body.appendChild(b); setTimeout(()=>b.remove(),2000);
Â  Â  }
}
function animateTableEffect() {
Â  Â  return new Promise(resolve => {
Â  Â  Â  Â  let centerEl = document.getElementById('play-area'); let rect = centerEl.getBoundingClientRect();
Â  Â  Â  Â  let centerX = rect.left + rect.width/2; let centerY = rect.top + rect.height/2;
Â  Â  Â  Â  let animCards = [];
Â  Â  Â  Â  ['player-hand','bot1-wrapper','bot2-wrapper','bot3-wrapper'].forEach(id => {
Â  Â  Â  Â  Â  Â  let el = document.getElementById(id); if(el) {
Â  Â  Â  Â  Â  Â  Â  Â  let r = el.getBoundingClientRect();
Â  Â  Â  Â  Â  Â  Â  Â  for(let k=0; k<3; k++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let ac = document.createElement('div'); ac.className = 'mini-card-back';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ac.style.zIndex = 5000; ac.style.left = r.left + 'px'; ac.style.top = r.top + 'px';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.body.appendChild(ac); animCards.push(ac);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  animCards.forEach(ac => { ac.style.transition = 'all 1.2s ease-in-out'; ac.style.left = (centerX - 30) + 'px'; ac.style.top = (centerY - 45) + 'px'; ac.style.transform = 'rotate(720deg)'; });
Â  Â  Â  Â  }, 50);
Â  Â  Â  Â  setTimeout(() => {Â 
Â  Â  Â  Â  Â  Â  animCards.forEach(ac => { let angle = Math.random() * Math.PI * 2; let dist = 400; ac.style.left = (centerX + Math.cos(angle)*dist) + 'px'; ac.style.top = (centerY + Math.sin(angle)*dist) + 'px'; ac.style.opacity = 0; });
Â  Â  Â  Â  Â  Â  setTimeout(() => { animCards.forEach(ac => ac.remove()); resolve(); }, 1200);
Â  Â  Â  Â  }, 1500);
Â  Â  });
}
function animateMixerEffect(dir) {
Â  Â  return new Promise(resolve => {
Â  Â  Â  Â  let dp = document.getElementById('play-area'); let rect = dp.getBoundingClientRect();
Â  Â  Â  Â  let cx = rect.left + rect.width/2; let cy = rect.top + rect.height/2;
Â  Â  Â  Â  let mixerContainer = document.createElement('div'); mixerContainer.className = 'mixer-container'; mixerContainer.style.left = cx + 'px'; mixerContainer.style.top = cy + 'px';
Â  Â  Â  Â  document.body.appendChild(mixerContainer);
Â  Â  Â  Â  for(let i=0; i<8; i++) {
Â  Â  Â  Â  Â  Â  let c = document.createElement('div'); c.className = 'mixer-card card-back-style'; c.style.transform = `rotate(${(i/8)*360}deg) translateY(-70px)`; mixerContainer.appendChild(c);
Â  Â  Â  Â  }
Â  Â  Â  Â  setTimeout(() => { mixerContainer.style.transition = 'transform 2s ease-in-out'; mixerContainer.style.transform = `rotate(${dir * 720}deg)`; }, 100);
Â  Â  Â  Â  setTimeout(() => { mixerContainer.remove(); resolve(); }, 2200);
Â  Â  });
}
function animatePotEffect(senderIdx, dir) {
Â  Â  let source = document.getElementById('draw-pile');
Â  Â  for(let k=0; k<4; k++) {
Â  Â  Â  Â  let targetPIdx = (senderIdx + (k * dir) + 4) % 4;
Â  Â  Â  Â  let targetId = targetPIdx === myPlayerIdx ? 'player-hand' : `bot${(targetPIdx - myPlayerIdx + 4) % 4}-wrapper`;
Â  Â  Â  Â  setTimeout(() => {Â 
Â  Â  Â  Â  Â  Â  animateFly(source, document.getElementById(targetId), null);Â 
Â  Â  Â  Â  }, k * ANIM_CONFIG.DRAW_INTERVAL);
Â  Â  }
}
function animateMezeEffect(senderIdx) {
Â  Â  let prevIdx = (senderIdx - direction + 4) % 4;
Â  Â  let targetId = prevIdx === myPlayerIdx ? 'player-hand' : `bot${(prevIdx - myPlayerIdx + 4) % 4}-wrapper`;
Â  Â  animateFly(document.getElementById('draw-pile'), document.getElementById(targetId), null);
}
async function animateInitialDeal() {
Â  Â  let piles = [];
Â  Â  isDealing = true;Â 
Â  Â  document.getElementById('player-hand').innerHTML = '';
Â  Â Â 
Â  Â  let targets = ['player-hand', 'bot1-wrapper', 'bot2-wrapper', 'bot3-wrapper'];
Â  Â  let myHandClone = [...gameHands[myPlayerIdx]];Â 
Â  Â  let myCardIndex = 0;

Â  Â  for(let round=0; round<7; round++) {
Â  Â  Â  Â  for(let p=0; p<4; p++) {
Â  Â  Â  Â  Â  Â  let targetId = targets[p];
Â  Â  Â  Â  Â  Â  let cardHtml = null;
Â  Â  Â  Â  Â  Â  if (p === 0 && myCardIndex < myHandClone.length) {
Â  Â  Â  Â  Â  Â  Â  Â  cardHtml = createCardHTML(myHandClone[myCardIndex]);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  animateFly(document.getElementById('draw-pile'), document.getElementById(targetId), cardHtml, () => {
Â  Â  Â  Â  Â  Â  Â  Â  if (p === 0 && cardHtml) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let div = document.createElement('div');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  div.innerHTML = cardHtml;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let el = div.firstElementChild;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  el.style.opacity = 0.6;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('player-hand').appendChild(el);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  if(p===0) myCardIndex++;
Â  Â  Â  Â  Â  Â  await wait(ANIM_CONFIG.INITIAL_DEAL);Â 
Â  Â  Â  Â  }
Â  Â  }
Â  Â  document.getElementById('player-hand').innerHTML = '';
Â  Â  isDealing = false;Â 
Â  Â  updateUI();
}
function startVegetableRain() {
Â  Â  const canvas = document.getElementById('confetti-canvas'); const ctx = canvas.getContext('2d');
Â  Â  canvas.width = window.innerWidth; canvas.height = window.innerHeight;
Â  Â  const emojis = ['ğŸ¥¦', 'ğŸ…', 'ğŸ¥”', 'ğŸ†']; let drops = [];
Â  Â  for(let i=0; i<30; i++) drops.push({x:Math.random()*canvas.width, y:-50, vy:Math.random()*3+2, vx:Math.random()*2-1, rot:Math.random()*360, rotSpeed:(Math.random()-0.5)*5, emoji:emojis[Math.floor(Math.random()*4)], size:Math.random()*20+20});
Â  Â  let isActive = true; setTimeout(() => isActive=false, 4000);
Â  Â  function animate() {
Â  Â  Â  Â  ctx.clearRect(0, 0, canvas.width, canvas.height);
Â  Â  Â  Â  if(isActive && Math.random() < 0.3) drops.push({x:Math.random()*canvas.width, y:-50, vy:Math.random()*3+2, vx:Math.random()*2-1, rot:Math.random()*360, rotSpeed:(Math.random()-0.5)*5, emoji:emojis[Math.floor(Math.random()*4)], size:Math.random()*20+20});
Â  Â  Â  Â  for (let i = 0; i < drops.length; i++) {
Â  Â  Â  Â  Â  Â  let d = drops[i]; ctx.save(); ctx.translate(d.x, d.y); ctx.rotate(d.rot * Math.PI / 180); ctx.font = `${d.size}px Arial`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(d.emoji, 0, 0); ctx.restore();
Â  Â  Â  Â  Â  Â  d.y += d.vy; d.x += d.vx + Math.sin(d.y / 50) * 0.5; d.rot += d.rotSpeed;
Â  Â  Â  Â  Â  Â  if (d.y > canvas.height + 50) { if(isActive) drops[i] = {x:Math.random()*canvas.width, y:-50, vy:Math.random()*3+2, vx:Math.random()*2-1, rot:Math.random()*360, rotSpeed:(Math.random()-0.5)*5, emoji:emojis[Math.floor(Math.random()*4)], size:Math.random()*20+20}; else { drops.splice(i, 1); i--; } }
Â  Â  Â  Â  }
Â  Â  Â  Â  if (drops.length > 0 || isActive) requestAnimationFrame(animate); else ctx.clearRect(0, 0, canvas.width, canvas.height);
Â  Â  }
Â  Â  animate();
}

function openRules() { document.getElementById('rules-modal').style.display = 'flex'; }
function leaveGame() { document.getElementById('leave-modal').style.display = 'flex'; }
function confirmLeaveGame() {
Â  Â  // 1. Modal ve Oyun AlanlarÄ±nÄ± Gizle
Â  Â  document.getElementById('leave-modal').style.display = 'none';
Â  Â  document.getElementById('end-modal').style.display = 'none';
Â  Â  document.getElementById('main-game-wrapper').style.display = 'none';
Â  Â  document.getElementById('waiting-room-overlay').style.display = 'none';

Â  Â  // 2. Offline Mode ise basit reset
Â  Â  if(isOfflineMode) {
Â  Â  Â  Â  resetToLobbyState();
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  // 3. Online Mode ise Firebase'den dÃ¼ÅŸÃ¼r
Â  Â  if(currentRoomId) {
Â  Â  Â  Â  // Oturumu kapatmadan sadece odadan oyuncuyu sil / bota Ã§evir
Â  Â  Â  Â  db.collection("rooms").doc(currentRoomId).get().then(doc => {
Â  Â  Â  Â  Â  Â  if(!doc.exists) { resetToLobbyState(); return; }
Â  Â  Â  Â  Â  Â  let ps = doc.data().players || [];
Â  Â  Â  Â  Â  Â  let rData = doc.data();
Â  Â  Â  Â  Â  Â  let isPlaying = rData.status === 'playing';

Â  Â  Â  Â  Â  Â  // Host bekleme odasÄ±ndayken Ã§Ä±karsa odayÄ± sil
Â  Â  Â  Â  Â  Â  if(isHost && !isPlaying) {
Â  Â  Â  Â  Â  Â  Â  Â  Â db.collection("rooms").doc(currentRoomId).delete()
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .then(() => resetToLobbyState())
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .catch(() => resetToLobbyState());
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Son oyuncu Ã§Ä±karsa odayÄ± sil
Â  Â  Â  Â  Â  Â  if(ps.length <= 1) {
Â  Â  Â  Â  Â  Â  Â  Â  db.collection("rooms").doc(currentRoomId).delete()
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .then(() => resetToLobbyState())
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .catch(() => resetToLobbyState());
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  let newPs;
Â  Â  Â  Â  Â  Â  Â  Â  // Oyun devam ediyorsa bota Ã§evir
Â  Â  Â  Â  Â  Â  Â  Â  if(isPlaying) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  newPs = ps.map(p => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(p.uid === myUid) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return { ...p, uid: 'replaced_bot_' + Date.now(), name: 'ğŸ¤– ' + p.name, isBot: true, isReady: true, personality: 'Agresif', lastSeen: Date.now() };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return p;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Bekleme odasÄ±ndaysa listeden sil
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  newPs = ps.filter(p => p.uid !== myUid);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  db.collection("rooms").doc(currentRoomId).update({ players: newPs })
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .then(() => resetToLobbyState())
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .catch(() => resetToLobbyState());
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  } else {
Â  Â  Â  Â  resetToLobbyState();
Â  Â  }
}

function resetToLobbyState() {
Â  Â  // DeÄŸiÅŸkenleri SÄ±fÄ±rla
Â  Â  currentRoomId = null;Â 
Â  Â  isHost = false;Â 
Â  Â  isOfflineMode = false;
Â  Â  if(roomUnsubscribe) roomUnsubscribe();
Â  Â  if(heartbeatInterval) clearInterval(heartbeatInterval);
Â  Â Â 
Â  Â  // UI Reset
Â  Â  document.getElementById('main-game-wrapper').style.display = 'none';
Â  Â  document.getElementById('new-lobby-screen').style.display = 'flex';
Â  Â Â 
Â  Â  // Status Update
Â  Â  if(myUid) db.collection('online_users').doc(myUid).update({status: 'lobby'});
Â  Â Â 
Â  Â  // Listeleri taze tut
Â  Â  listenRooms();
}

/* --- UTILS --- */
const VEGETABLES = { red: 'ğŸ…', green: 'ğŸ¥¦', yellow: 'ğŸ¥”', purple: 'ğŸ†' };
const SPECIALS = { '+1': 'ğŸ“¦', '+2': 'ğŸ“¦ğŸ“¦', 'Reverse': 'â™»ï¸', 'Block': 'ğŸ”ª', 'Wild': 'GUVEC', 'Wild Anti-Draw': 'ğŸ§»', 'Wild Pot': 'ğŸ²', 'Wild Table': 'ğŸ½ï¸', 'Wild Mixer': 'ğŸŒªï¸', 'Wild Meze': 'ğŸ±' };
function createCardHTML(card) {
Â  Â  let emoji = (card.type === 'num') ? VEGETABLES[card.color] : (card.val === 'Wild' ? `<div class="guvec-grid"><span>ğŸ…</span><span>ğŸ¥¦</span><span>ğŸ¥”</span><span>ğŸ†</span></div>` : (SPECIALS[card.val] || card.val));
Â  Â  let cls = (card.color === 'wild') ? 'wild-bg' : card.color;
Â  Â  let borderStyle = card.chosenColor ? `border-color: ${card.chosenColor==='red'?'#e74c3c':card.chosenColor==='green'?'#2ecc71':card.chosenColor==='yellow'?'#f39c12':'#9b59b6'} !important; border-width: 3px;` : '';
Â  Â  let cornerTxt = (card.type === 'num') ? card.val : '';
Â  Â  return `<div class="card ${cls}" style="${borderStyle}"><div class="card-corner top-left">${cornerTxt}</div><div class="card-emoji">${emoji}</div><div class="card-corner bottom-right">${cornerTxt}</div></div>`;
}
function toggleInfoView(el) { el.classList.toggle('flipped'); }
function openPatternModal() {Â 
Â  Â  const grid = document.getElementById('pattern-grid'); grid.innerHTML = '';Â 
Â  Â  CARD_PATTERNS.forEach(p => {Â 
Â  Â  Â  Â  let d = document.createElement('div');Â 
Â  Â  Â  Â  d.className = 'pattern-opt';Â 
Â  Â  Â  Â  d.style.background = p;Â 
Â  Â  Â  Â  d.onclick = () => {Â 
Â  Â  Â  Â  Â  Â  document.documentElement.style.setProperty('--card-pattern', p);
Â  Â  Â  Â  Â  Â  currentPattern = p;Â 
Â  Â  Â  Â  Â  Â  updateUI();Â 
Â  Â  Â  Â  Â  Â  closePatternModal();Â 
Â  Â  Â  Â  };Â 
Â  Â  Â  Â  grid.appendChild(d);Â 
Â  Â  });Â 
Â  Â  document.getElementById('pattern-modal').style.display = 'flex';Â 
}
function closePatternModal() { document.getElementById('pattern-modal').style.display = 'none'; }
function handleChatKey(e) { if(e.key === 'Enter') playerSendMessage(); }
function toggleReadyState() {Â 
Â  Â  if(isOfflineMode) {
Â  Â  Â  Â  Â amIReady = !amIReady;Â 
Â  Â  Â  Â  Â let btn = document.getElementById('end-continue-btn');Â 
Â  Â  Â  Â  Â btn.innerText = amIReady ? "Bekleniyor..." : "Devam Et â³";Â 
Â  Â  Â  Â  Â btn.classList.toggle('btn-blue'); btn.classList.toggle('btn-dark');
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â // In offline mode, assume bots are ready after delay
Â  Â  Â  Â  Â setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â if(amIReady) nextRound();
Â  Â  Â  Â  Â }, 2000);
Â  Â  Â  Â  Â return;
Â  Â  }

Â  Â  if(!currentRoomId) return; amIReady = !amIReady; let btn = document.getElementById('end-continue-btn'); btn.innerText = amIReady ? "Bekleniyor..." : "Devam Et â³"; btn.classList.toggle('btn-blue'); btn.classList.toggle('btn-dark'); let ps = [...gamePlayers]; let meIdx = ps.findIndex(p => p.uid === myUid); if(meIdx !== -1) { ps[meIdx].isReady = amIReady; db.collection("rooms").doc(currentRoomId).update({ players: ps, lastActive: Date.now() }); } }

const cleanupRoom = async () => { if(heartbeatInterval) clearInterval(heartbeatInterval); };

function shuffleDeck(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }
function createFullDeck() { let d = []; ['red','green','yellow','purple'].forEach(c => { d.push({color:c,val:'0',type:'num',name:'0'}); for(let i=1; i<=9; i++) d.push({color:c,val:i.toString(),type:'num',name:i}); ['+1','Reverse','Block'].forEach(v=>d.push({color:c,val:v,type:'action',name:v})); }); for(let i=0;i<2;i++) { d.push({color:'wild',val:'Wild',type:'wild',name:'GÃ¼veÃ§'}); d.push({color:'wild',val:'+2',type:'wild',name:'+2'}); d.push({color:'wild',val:'Wild Anti-Draw',type:'wild',name:'Tuvalet KaÄŸÄ±dÄ±'}); d.push({color:'wild',val:'Wild Pot',type:'wild',name:'DÃ¼dÃ¼klÃ¼ Tencere'}); d.push({color:'wild',val:'Wild Meze',type:'wild',name:'Meze'}); } d.push({color:'wild',val:'Wild Table',type:'wild',name:'Sofra'}); d.push({color:'wild',val:'Wild Mixer',type:'wild',name:'Mikser'}); return shuffleDeck(d); }
function showSonTabakPopup(name) { let p = document.getElementById('son-tabak-popup'); document.getElementById('son-tabak-who').innerText = name + " dedi!"; p.style.display = 'block'; setTimeout(() => p.style.display = 'none', ANIM_CONFIG.POPUP); }
function showChallengePopup(success, title, detail) {Â 
Â  Â  let p = document.getElementById('challenge-popup');Â 
Â  Â  document.getElementById('challenge-who').innerText = title || "Ä°TÄ°RAZ!";Â 
Â  Â  document.getElementById('challenge-result').innerText = detail || (success ? "BAÅARILI! âœ…" : "HATALI! âŒ");Â 
Â  Â  p.className = success ? 'challenge-valid' : 'challenge-invalid';Â 
Â  Â  p.style.display = 'block';Â 
Â  Â  setTimeout(() => p.style.display = 'none', ANIM_CONFIG.POPUP);Â 
}
function addSystemLog(html) { const logList = document.getElementById('system-log'); const li = document.createElement('li'); li.innerHTML = html; logList.prepend(li); }
function addChatLog(name, msg, color) { const chatDiv = document.getElementById('chat-messages'); const msgDiv = document.createElement('div'); msgDiv.className = `chat-line`; msgDiv.innerHTML = `<span class="chat-name" style="color:${color}; font-weight:bold;">${name}:</span><span class="chat-text">${msg}</span>`; chatDiv.appendChild(msgDiv); chatDiv.scrollTop = chatDiv.scrollHeight; }
function showToast(msg) { let t = document.getElementById('toast'); t.innerText = msg; t.style.display = 'block'; setTimeout(() => t.style.display = 'none', ANIM_CONFIG.TOAST); }
function showEndGame(winnerIdx, finalPlayers) {
Â  Â  lastWinner = winnerIdx;
Â  Â  const winnerName = finalPlayers[winnerIdx].name;
Â  Â  document.getElementById('winner-text').innerText = `ğŸ‰ ${winnerName} KazandÄ±!`;
Â  Â  document.getElementById('ai-summary').innerHTML = `ğŸ¤ <b>Spiker:</b> "Vay vay vay! ${winnerName} resmen masayÄ± sÃ¼pÃ¼rdÃ¼!"`;
Â  Â  document.getElementById('end-modal').style.display = 'flex';
Â  Â  updateReadyStatusUI(); startVegetableRain(); SoundFX.playFanfare();
}
function updateReadyStatusUI() {
Â  Â  let allReady = true; gamePlayers.forEach(p => { if(!p.isBot && !p.isReady) allReady = false; });
Â  Â  let sortedP = [...gamePlayers].sort((a,b)=>a.score - b.score);
Â  Â  let html = `<table style="width:100%; border-collapse:collapse;">`;Â 
Â  Â  sortedP.forEach(p => {Â 
Â  Â  Â  Â  let isMe = p.uid === myUid;Â 
Â  Â  Â  Â  let pColor = playerColors[gamePlayers.findIndex(x=>x.uid===p.uid)] || '#333';
Â  Â  Â  Â  let lastRoundScore = p.lastRoundScore !== undefined ? `+${p.lastRoundScore}` : '';
Â  Â  Â  Â  html += `<tr style="${isMe ? 'background-color: #fff9c4; font-weight: bold; border-left: 4px solid #f1c40f;' : ''}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="padding: 8px 10px; border-bottom: 1px solid #eee; color:${pColor};">${p.name}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="padding: 8px 10px; border-bottom: 1px solid #eee; text-align:right;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="color:#e74c3c; font-size:0.9em; margin-right:5px;">${lastRoundScore}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (Toplam: ${p.score}) ${(p.isReady||p.isBot)?'âœ…':'â³'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â </tr>`;Â 
Â  Â  });
Â  Â  html += `</table>`;
Â  Â  document.getElementById('final-scores').innerHTML = html;
Â  Â  if(isHost) document.getElementById('host-start-btn').style.display = allReady ? 'block' : 'none';
}
const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));
</script>
</body>
</html>

bu html oynunun firebase kullanÄ±mÄ±nÄ± ÅŸiÅŸirmemesi iÃ§in nasÄ±l bir optimizasyon yapabiliriz??
basit bir oyun ama ÅŸuan 5 el de flan server Ã¼cretsiz kullanÄ±mÄ±nÄ±n Ã§eyreÄŸini yiyor.
Opimizasyonu deÄŸiÅŸikliklerini uygun ÅŸekilde yap ama sakÄ±n deÄŸiÅŸtirmediÄŸin kodlarÄ± elleme (azaltma, deÄŸiÅŸtirme, kÄ±saltma, aynÄ± kalsÄ±n KESÄ°NLÄ°KLE)
